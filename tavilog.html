<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaviLog - æ—…ã®è¨˜éŒ²ã‚’ãƒ–ãƒ­ã‚°ã«</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #FF6B6B;
      --secondary: #4ECDC4;
      --accent: #FFE66D;
      --purple: #A66CFF;
      --bg: #FFF9F0;
      --card: #FFFFFF;
      --text: #2D3436;
      --text-light: #636E72;
      --shadow: 0 8px 32px rgba(255, 107, 107, 0.15);
      --shadow-hover: 0 12px 48px rgba(255, 107, 107, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Zen Maru Gothic', 'Quicksand', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      right: -30%;
      width: 80%;
      height: 80%;
      background: radial-gradient(circle, rgba(78, 205, 196, 0.1) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    body::after {
      content: '';
      position: fixed;
      bottom: -30%;
      left: -20%;
      width: 60%;
      height: 60%;
      background: radial-gradient(circle, rgba(255, 107, 107, 0.08) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      padding: 2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: 'âœˆï¸ ğŸ—ºï¸ ğŸ“¸ ğŸŒ´ â›©ï¸ ğŸ”ï¸';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 8rem;
      opacity: 0.1;
      white-space: nowrap;
      pointer-events: none;
    }

    .logo {
      font-family: 'Quicksand', sans-serif;
      font-size: 3rem;
      font-weight: 700;
      color: white;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
      position: relative;
      display: inline-block;
    }

    .logo span {
      color: var(--accent);
    }

    .tagline {
      color: rgba(255,255,255,0.9);
      margin-top: 0.5rem;
      font-size: 1.1rem;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .tab-btn {
      flex: 1;
      min-width: 150px;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 20px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--card);
      color: var(--text-light);
      box-shadow: var(--shadow);
    }

    .tab-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      color: white;
    }

    .tab-btn .icon {
      margin-right: 0.5rem;
    }

    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ç´ æè¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .add-section {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* æ—…è¡Œé¸æŠãƒ»ä½œæˆ */
    .trip-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .trip-select {
      flex: 1;
      min-width: 200px;
      padding: 1rem;
      border: 2px solid #E0E0E0;
      border-radius: 16px;
      font-family: inherit;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .trip-select:focus {
      outline: none;
      border-color: var(--secondary);
    }

    .btn-new-trip {
      padding: 1rem 2rem;
      border: 2px dashed var(--secondary);
      border-radius: 16px;
      background: rgba(78, 205, 196, 0.1);
      color: var(--secondary);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-new-trip:hover {
      background: var(--secondary);
      color: white;
      border-style: solid;
    }

    /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
    .dropzone {
      border: 3px dashed #DDD;
      border-radius: 20px;
      padding: 3rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, rgba(255,107,107,0.03) 0%, rgba(78,205,196,0.03) 100%);
      margin-bottom: 1.5rem;
    }

    .dropzone:hover,
    .dropzone.dragover {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(255,107,107,0.08) 0%, rgba(78,205,196,0.08) 100%);
      transform: scale(1.01);
    }

    .dropzone-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .dropzone-text {
      font-size: 1.2rem;
      color: var(--text-light);
    }

    .dropzone-hint {
      font-size: 0.9rem;
      color: #AAA;
      margin-top: 0.5rem;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› */
    .text-input-area {
      margin-top: 1.5rem;
    }

    .text-input {
      width: 100%;
      min-height: 120px;
      padding: 1.5rem;
      border: 2px solid #E0E0E0;
      border-radius: 16px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      transition: border-color 0.3s;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--secondary);
    }

    .text-input::placeholder {
      color: #BBB;
    }

    .btn-add-text {
      margin-top: 1rem;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, var(--secondary) 0%, #45B7AA 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-add-text:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(78, 205, 196, 0.4);
    }

    /* ç´ æä¸€è¦§ */
    .materials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .material-card {
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s;
      position: relative;
    }

    .material-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }

    .material-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .material-card .text-preview {
      padding: 1rem;
      font-size: 0.9rem;
      color: var(--text-light);
      height: 150px;
      overflow: hidden;
      background: linear-gradient(135deg, rgba(255,230,109,0.2) 0%, rgba(166,108,255,0.1) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .material-card .card-footer {
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #F0F0F0;
    }

    .material-type {
      font-size: 0.8rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-weight: 600;
    }

    .type-photo {
      background: rgba(255, 107, 107, 0.15);
      color: var(--primary);
    }

    .type-text {
      background: rgba(78, 205, 196, 0.15);
      color: var(--secondary);
    }

    .btn-delete {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.3s;
    }

    .btn-delete:hover {
      opacity: 1;
    }

    /* ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .generate-section {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .trip-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(166,108,255,0.1) 100%);
      padding: 1.5rem;
      border-radius: 16px;
      text-align: center;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }

    .generate-options {
      margin-bottom: 2rem;
    }

    .option-group {
      margin-bottom: 1.5rem;
    }

    .option-label {
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: block;
    }

    .style-options {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .style-option {
      padding: 0.75rem 1.5rem;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      background: white;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s;
    }

    .style-option:hover {
      border-color: var(--primary);
    }

    .style-option.selected {
      border-color: var(--primary);
      background: rgba(255, 107, 107, 0.1);
      color: var(--primary);
      font-weight: 600;
    }

    .btn-generate {
      width: 100%;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      color: white;
      border: none;
      border-radius: 16px;
      font-family: inherit;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(255, 107, 107, 0.4);
    }

    .btn-generate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* ãƒ–ãƒ­ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .preview-section {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .preview-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn-action {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-copy {
      background: var(--secondary);
      color: white;
    }

    .btn-download {
      background: var(--purple);
      color: white;
    }

    .btn-action:hover {
      transform: translateY(-2px);
    }

    .preview-frame {
      border: 1px solid #E0E0E0;
      border-radius: 16px;
      min-height: 400px;
      padding: 2rem;
      background: white;
    }

    .preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: var(--text-light);
    }

    .preview-placeholder-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* APIã‚­ãƒ¼è¨­å®šãƒãƒ¼ */
    .api-key-bar {
      background: linear-gradient(135deg, #2D3436 0%, #636E72 100%);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .api-key-bar label {
      color: white;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .ai-select {
      padding: 0.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      background: white;
      cursor: pointer;
    }

    .api-key-input {
      flex: 1;
      min-width: 120px;
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.8rem;
    }

    .api-key-status {
      padding: 0.4rem 0.6rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .api-key-status.valid {
      background: rgba(78, 205, 196, 0.2);
      color: #4ECDC4;
    }

    .api-key-status.invalid {
      background: rgba(255, 107, 107, 0.2);
      color: #FF6B6B;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }

    .modal-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--secondary);
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn-modal {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: #E0E0E0;
      color: var(--text);
    }

    .btn-confirm {
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      color: white;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 2rem;
      background: var(--text);
      color: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--secondary);
    }

    .toast.error {
      background: var(--primary);
    }

    /* è¨­å®šã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .settings-group {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #E0E0E0;
    }

    .settings-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-subtitle {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text);
    }

    .storage-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .storage-option {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1rem;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .storage-option:hover {
      border-color: var(--secondary);
    }

    .storage-option input[type="radio"] {
      margin-top: 0.25rem;
      accent-color: var(--secondary);
      width: 18px;
      height: 18px;
    }

    .storage-option input[type="radio"]:checked + .storage-option-content {
      color: var(--text);
    }

    .storage-option:has(input:checked) {
      border-color: var(--secondary);
      background: rgba(78, 205, 196, 0.05);
    }

    .storage-option-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .storage-option-desc {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .gdrive-settings {
      background: linear-gradient(135deg, rgba(66, 133, 244, 0.05) 0%, rgba(52, 168, 83, 0.05) 100%);
      padding: 1.5rem;
      border-radius: 16px;
      margin-top: 1rem;
    }

    .gdrive-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: white;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .gdrive-status.connected .status-icon { color: #34A853; }
    .gdrive-status.disconnected .status-icon { color: #EA4335; }

    .gdrive-input-group {
      margin-bottom: 1rem;
    }

    .gdrive-input-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .gdrive-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn-gdrive-connect {
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-gdrive-connect:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }

    .btn-gdrive-disconnect {
      padding: 0.75rem 1.5rem;
      background: #E0E0E0;
      color: var(--text);
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .setup-guide {
      margin-top: 1.5rem;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }

    .setup-guide summary {
      padding: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #F8F8F8;
    }

    .setup-guide summary:hover {
      background: #F0F0F0;
    }

    .guide-content {
      padding: 1rem;
    }

    .guide-step {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .guide-step:last-child {
      margin-bottom: 0;
    }

    .step-number {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .step-content {
      flex: 1;
    }

    .step-content strong {
      display: block;
      margin-bottom: 0.25rem;
    }

    .step-content p {
      font-size: 0.9rem;
      color: var(--text-light);
      margin: 0;
    }

    .step-content code {
      background: #F0F0F0;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .step-content a {
      color: var(--secondary);
      word-break: break-all;
    }

    .data-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn-data-action {
      padding: 0.75rem 1rem;
      background: white;
      border: 2px solid #E0E0E0;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-data-action:hover {
      border-color: var(--secondary);
      background: rgba(78, 205, 196, 0.05);
    }

    .btn-data-action.btn-danger {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-data-action.btn-danger:hover {
      background: rgba(255, 107, 107, 0.1);
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .logo {
        font-size: 2rem;
      }

      .tabs {
        gap: 0.5rem;
      }

      .tab-btn {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        min-width: auto;
      }

      .dropzone {
        padding: 2rem;
      }

      .dropzone-icon {
        font-size: 3rem;
      }

      .materials-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 class="logo">Tavi<span>Log</span></h1>
    <p class="tagline">æ—…ã®æ€ã„å‡ºã‚’ã€ç´ æ•µãªãƒ–ãƒ­ã‚°ã« âœ¨</p>
  </header>

  <!-- APIã‚­ãƒ¼è¨­å®šãƒãƒ¼ -->
  <div class="api-key-bar">
    <label>ğŸ¤– AI:</label>
    <select id="aiProvider" class="ai-select">
      <option value="openai">ChatGPT (OpenAI)</option>
      <option value="anthropic">Claude (Anthropic)</option>
    </select>
    <label>ğŸ”‘</label>
    <input type="password" class="api-key-input" id="apiKeyInput" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›...">
    <span class="api-key-status invalid" id="apiKeyStatus">æœªè¨­å®š</span>
  </div>

  <div class="container">
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="add">
        <span class="icon">ğŸ“</span>ç´ æã‚’è¿½åŠ 
      </button>
      <button class="tab-btn" data-tab="materials">
        <span class="icon">ğŸ“¦</span>ç´ æä¸€è¦§
      </button>
      <button class="tab-btn" data-tab="generate">
        <span class="icon">âœ¨</span>ãƒ–ãƒ­ã‚°ç”Ÿæˆ
      </button>
      <button class="tab-btn" data-tab="preview">
        <span class="icon">ğŸ‘€</span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      </button>
      <button class="tab-btn" data-tab="settings">
        <span class="icon">âš™ï¸</span>è¨­å®š
      </button>
    </nav>

    <!-- ç´ æè¿½åŠ ã‚¿ãƒ– -->
    <div id="tab-add" class="tab-content active">
      <div class="add-section">
        <h2 class="section-title">ğŸ§³ æ—…ã‚’é¸ã‚“ã§ç´ æã‚’è¿½åŠ </h2>
        
        <div class="trip-selector">
          <select id="tripSelect" class="trip-select">
            <option value="">æ—…è¡Œã‚’é¸æŠ...</option>
          </select>
          <button class="btn-new-trip" onclick="openNewTripModal()">
            â• æ–°ã—ã„æ—…ã‚’ä½œæˆ
          </button>
        </div>

        <div class="dropzone" id="dropzone">
          <div class="dropzone-icon">ğŸ“¸</div>
          <p class="dropzone-text">å†™çœŸã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
          <p class="dropzone-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
          <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
        </div>

        <div class="text-input-area">
          <textarea 
            class="text-input" 
            id="textInput" 
            placeholder="æ—…ã®æ€ã„å‡ºã‚„ãƒ¡ãƒ¢ã‚’è‡ªç”±ã«æ›¸ã„ã¦ã­ ğŸ–Šï¸&#10;&#10;ä¾‹ï¼š&#10;ãƒ»ä»Šæ—¥ã¯ç®±æ ¹ã®æ¸©æ³‰ã«è¡Œã£ãŸï¼éœ²å¤©é¢¨å‘‚ã‹ã‚‰è¦‹ãŸå¯Œå£«å±±ãŒæœ€é«˜ã ã£ãŸã€‚&#10;ãƒ»ãƒ©ãƒ³ãƒã¯é»’ãŸã¾ã”é£Ÿã¹ãŸã€‚æ„å¤–ã¨ãŠã„ã—ã„ç¬‘"></textarea>
          <button class="btn-add-text" onclick="addTextMaterial()">
            ğŸ’¬ ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
          </button>
        </div>
      </div>
    </div>

    <!-- ç´ æä¸€è¦§ã‚¿ãƒ– -->
    <div id="tab-materials" class="tab-content">
      <div class="add-section">
        <h2 class="section-title">ğŸ“¦ ä¿å­˜ã•ã‚ŒãŸç´ æ</h2>
        
        <div class="trip-selector">
          <select id="materialsFilterTrip" class="trip-select" onchange="renderMaterials()">
            <option value="">ã™ã¹ã¦ã®æ—…è¡Œ</option>
          </select>
        </div>

        <div id="materialsGrid" class="materials-grid">
          <!-- ç´ æã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å…¥ã‚‹ -->
        </div>

        <div id="materialsEmpty" class="empty-state" style="display:none;">
          <div class="empty-icon">ğŸ–ï¸</div>
          <p>ã¾ã ç´ æãŒãªã„ã‚ˆï¼<br>å†™çœŸã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã¿ã‚ˆã†</p>
        </div>
      </div>
    </div>

    <!-- ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚¿ãƒ– -->
    <div id="tab-generate" class="tab-content">
      <div class="generate-section">
        <h2 class="section-title">âœ¨ ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆ</h2>

        <div class="trip-selector">
          <select id="generateTripSelect" class="trip-select">
            <option value="">ç”Ÿæˆã™ã‚‹æ—…è¡Œã‚’é¸æŠ...</option>
          </select>
        </div>

        <div class="trip-stats" id="tripStats">
          <div class="stat-card">
            <div class="stat-number" id="photoCount">0</div>
            <div class="stat-label">å†™çœŸ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="textCount">0</div>
            <div class="stat-label">ãƒ†ã‚­ã‚¹ãƒˆ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">åˆè¨ˆç´ æ</div>
          </div>
        </div>

        <div class="generate-options">
          <div class="option-group">
            <label class="option-label">ğŸ“ æ–‡ç« ã®ã‚¹ã‚¿ã‚¤ãƒ«</label>
            <div class="style-options">
              <button class="style-option selected" data-style="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</button>
              <button class="style-option" data-style="diary">æ—¥è¨˜é¢¨</button>
              <button class="style-option" data-style="magazine">æ—…è¡Œé›‘èªŒé¢¨</button>
              <button class="style-option" data-style="poetic">ã‚¨ãƒ¢ã„æ„Ÿã˜</button>
            </div>
          </div>
        </div>

        <button class="btn-generate" id="generateBtn" onclick="generateBlog()">
          <span class="btn-text">ğŸš€ ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆã™ã‚‹</span>
          <div class="loading">
            <div class="spinner"></div>
            <span>ç”Ÿæˆä¸­...</span>
          </div>
        </button>
      </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
    <div id="tab-preview" class="tab-content">
      <div class="preview-section">
        <div class="preview-header">
          <h2 class="section-title">ğŸ‘€ ãƒ–ãƒ­ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
          <div class="preview-actions">
            <button class="btn-action btn-copy" onclick="copyBlog()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button class="btn-action btn-download" onclick="downloadBlog()">ğŸ’¾ HTMLä¿å­˜</button>
            <button class="btn-action btn-download" onclick="downloadPdf()">ğŸ“„ PDFä¿å­˜</button>
          </div>
        </div>

        <div class="preview-frame" id="previewFrame">
          <div class="preview-placeholder">
            <div class="preview-placeholder-icon">ğŸ“</div>
            <p>ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          </div>
        </div>
      </div>
    </div>

    <!-- è¨­å®šã‚¿ãƒ– -->
    <div id="tab-settings" class="tab-content">
      <div class="add-section">
        <h2 class="section-title">âš™ï¸ è¨­å®š</h2>
        
        <!-- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š -->
        <div class="settings-group">
          <h3 class="settings-subtitle">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜å…ˆ</h3>
          <div class="storage-options">
            <label class="storage-option">
              <input type="radio" name="storageType" value="local" checked onchange="changeStorageType('local')">
              <div class="storage-option-content">
                <div class="storage-option-title">ğŸ“± ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</div>
                <div class="storage-option-desc">è¨­å®šä¸è¦ã€ã™ãä½¿ãˆã‚‹ã€‚ãŸã ã—ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã¨ã¯åŒæœŸã•ã‚Œã¾ã›ã‚“ã€‚</div>
              </div>
            </label>
            <label class="storage-option">
              <input type="radio" name="storageType" value="gdrive" onchange="changeStorageType('gdrive')">
              <div class="storage-option-content">
                <div class="storage-option-title">â˜ï¸ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜</div>
                <div class="storage-option-desc">è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã§åŒæœŸå¯èƒ½ã€‚åˆå›è¨­å®šãŒå¿…è¦ã§ã™ã€‚</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Googleãƒ‰ãƒ©ã‚¤ãƒ–è¨­å®šï¼ˆgdriveé¸æŠæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="settings-group gdrive-settings" id="gdriveSettings" style="display:none;">
          <h3 class="settings-subtitle">â˜ï¸ Googleãƒ‰ãƒ©ã‚¤ãƒ–è¨­å®š</h3>
          
          <div class="gdrive-status" id="gdriveStatus">
            <span class="status-icon">âŒ</span>
            <span class="status-text">æœªæ¥ç¶š</span>
          </div>

          <div class="gdrive-input-group">
            <label>Client ID</label>
            <input type="text" class="modal-input" id="gdriveClientId" placeholder="xxxxx.apps.googleusercontent.com">
          </div>

          <div class="gdrive-actions">
            <button class="btn-gdrive-connect" id="gdriveConnectBtn" onclick="connectGoogleDrive()">
              ğŸ”— Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«æ¥ç¶š
            </button>
            <button class="btn-gdrive-disconnect" id="gdriveDisconnectBtn" onclick="disconnectGoogleDrive()" style="display:none;">
              ğŸ”Œ æ¥ç¶šè§£é™¤
            </button>
          </div>

          <!-- è¨­å®šã‚¬ã‚¤ãƒ‰ -->
          <details class="setup-guide">
            <summary>ğŸ“– Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®è¨­å®šæ–¹æ³•ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦é–‹ãï¼‰</summary>
            <div class="guide-content">
              <div class="guide-step">
                <div class="step-number">1</div>
                <div class="step-content">
                  <strong>Google Cloud Consoleã«ã‚¢ã‚¯ã‚»ã‚¹</strong>
                  <p><a href="https://console.cloud.google.com/" target="_blank">https://console.cloud.google.com/</a> ã‚’é–‹ã„ã¦Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</p>
                </div>
              </div>
              
              <div class="guide-step">
                <div class="step-number">2</div>
                <div class="step-content">
                  <strong>æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ</strong>
                  <p>ä¸Šéƒ¨ã®ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã€â†’ã€Œæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€â†’ åå‰ã‚’ã€ŒTaviLogã€ãªã©ã«ã—ã¦ä½œæˆ</p>
                </div>
              </div>
              
              <div class="guide-step">
                <div class="step-number">3</div>
                <div class="step-content">
                  <strong>Google Drive APIã‚’æœ‰åŠ¹åŒ–</strong>
                  <p>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€â†’ã€ŒGoogle Drive APIã€ã‚’æ¤œç´¢ã—ã¦ã€Œæœ‰åŠ¹ã«ã™ã‚‹ã€</p>
                </div>
              </div>
              
              <div class="guide-step">
                <div class="step-number">4</div>
                <div class="step-content">
                  <strong>OAuthåŒæ„ç”»é¢ã‚’è¨­å®š</strong>
                  <p>ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€ŒOAuthåŒæ„ç”»é¢ã€â†’ã€Œå¤–éƒ¨ã€ã‚’é¸æŠ â†’ ã‚¢ãƒ—ãƒªåã¨ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ä¿å­˜</p>
                </div>
              </div>
              
              <div class="guide-step">
                <div class="step-number">5</div>
                <div class="step-content">
                  <strong>èªè¨¼æƒ…å ±ã‚’ä½œæˆ</strong>
                  <p>ã€Œèªè¨¼æƒ…å ±ã€â†’ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€â†’ã€ŒOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€â†’ ã‚¢ãƒ—ãƒªã®ç¨®é¡ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€</p>
                </div>
              </div>
              
              <div class="guide-step">
                <div class="step-number">6</div>
                <div class="step-content">
                  <strong>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’è¨­å®š</strong>
                  <p>ã€Œæ‰¿èªæ¸ˆã¿ã®JavaScriptç”Ÿæˆå…ƒã€ã«ä»Šé–‹ã„ã¦ã„ã‚‹URLï¼ˆä¾‹ï¼š<code id="currentOrigin"></code>ï¼‰ã‚’è¿½åŠ </p>
                </div>
              </div>
              
              <div class="guide-step">
                <div class="step-number">7</div>
                <div class="step-content">
                  <strong>Client IDã‚’ã‚³ãƒ”ãƒ¼</strong>
                  <p>ä½œæˆã•ã‚ŒãŸClient IDï¼ˆxxxxx.apps.googleusercontent.comã®å½¢å¼ï¼‰ã‚’ä¸Šã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘</p>
                </div>
              </div>
            </div>
          </details>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="settings-group">
          <h3 class="settings-subtitle">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
          <div class="data-actions">
            <button class="btn-data-action" onclick="exportData()">
              ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button class="btn-data-action" onclick="document.getElementById('importFile').click()">
              ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            </button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            <button class="btn-data-action btn-danger" onclick="clearAllData()">
              ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- æ–°è¦æ—…è¡Œãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="newTripModal">
    <div class="modal">
      <h3 class="modal-title">ğŸ§³ æ–°ã—ã„æ—…ã‚’ä½œæˆ</h3>
      <input type="text" class="modal-input" id="tripNameInput" placeholder="æ—…è¡Œã®åå‰ï¼ˆä¾‹ï¼šç®±æ ¹æ¸©æ³‰æ—…è¡Œ2024ï¼‰">
      <input type="date" class="modal-input" id="tripDateInput">
      <div class="modal-actions">
        <button class="btn-modal btn-cancel" onclick="closeNewTripModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-modal btn-confirm" onclick="createNewTrip()">ä½œæˆ</button>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="toast" id="toast"></div>

  <script>
    // IndexedDBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    const DB_NAME = 'TaviLogDB';
    const DB_VERSION = 1;
    let db;

    // DBåˆæœŸåŒ–
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // æ—…è¡Œã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains('trips')) {
            const tripStore = db.createObjectStore('trips', { keyPath: 'id', autoIncrement: true });
            tripStore.createIndex('name', 'name', { unique: false });
            tripStore.createIndex('date', 'date', { unique: false });
          }
          
          // ç´ æã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains('materials')) {
            const materialStore = db.createObjectStore('materials', { keyPath: 'id', autoIncrement: true });
            materialStore.createIndex('tripId', 'tripId', { unique: false });
            materialStore.createIndex('type', 'type', { unique: false });
            materialStore.createIndex('createdAt', 'createdAt', { unique: false });
          }
          
          // ç”Ÿæˆã•ã‚ŒãŸãƒ–ãƒ­ã‚°ã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains('blogs')) {
            const blogStore = db.createObjectStore('blogs', { keyPath: 'id', autoIncrement: true });
            blogStore.createIndex('tripId', 'tripId', { unique: false });
          }
        };
      });
    }

    // æ—…è¡Œã‚’å–å¾—
    async function getTrips() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['trips'], 'readonly');
        const store = transaction.objectStore('trips');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // æ—…è¡Œã‚’è¿½åŠ 
    async function addTrip(trip) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['trips'], 'readwrite');
        const store = transaction.objectStore('trips');
        const request = store.add(trip);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // ç´ æã‚’å–å¾—
    async function getMaterials(tripId = null) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['materials'], 'readonly');
        const store = transaction.objectStore('materials');
        
        if (tripId) {
          const index = store.index('tripId');
          const request = index.getAll(tripId);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        } else {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        }
      });
    }

    // ç´ æã‚’è¿½åŠ 
    async function addMaterial(material) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['materials'], 'readwrite');
        const store = transaction.objectStore('materials');
        const request = store.add(material);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // ç´ æã‚’å‰Šé™¤
    async function deleteMaterial(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['materials'], 'readwrite');
        const store = transaction.objectStore('materials');
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        if (btn.dataset.tab === 'materials') {
          renderMaterials();
        } else if (btn.dataset.tab === 'generate') {
          updateTripStats();
        }
      });
    });

    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');

    dropzone.addEventListener('click', () => fileInput.click());
    
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      await handleFiles(files);
    });

    fileInput.addEventListener('change', async (e) => {
      await handleFiles(e.target.files);
      fileInput.value = '';
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    async function handleFiles(files) {
      const tripId = parseInt(document.getElementById('tripSelect').value);
      if (!tripId) {
        showToast('å…ˆã«æ—…è¡Œã‚’é¸æŠã—ã¦ã­ï¼', 'error');
        return;
      }

      for (const file of files) {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            const material = {
              tripId: tripId,
              type: 'photo',
              content: e.target.result,
              fileName: file.name,
              createdAt: new Date().toISOString()
            };
            await addMaterial(material);
            showToast('å†™çœŸã‚’è¿½åŠ ã—ãŸã‚ˆï¼ ğŸ“¸', 'success');
          };
          reader.readAsDataURL(file);
        }
      }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
    async function addTextMaterial() {
      const tripId = parseInt(document.getElementById('tripSelect').value);
      const text = document.getElementById('textInput').value.trim();

      if (!tripId) {
        showToast('å…ˆã«æ—…è¡Œã‚’é¸æŠã—ã¦ã­ï¼', 'error');
        return;
      }

      if (!text) {
        showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ã­ï¼', 'error');
        return;
      }

      const material = {
        tripId: tripId,
        type: 'text',
        content: text,
        createdAt: new Date().toISOString()
      };

      await addMaterial(material);
      document.getElementById('textInput').value = '';
      showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ãŸã‚ˆï¼ ğŸ’¬', 'success');
    }

    // ç´ æä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    async function renderMaterials() {
      const filterTripId = document.getElementById('materialsFilterTrip').value;
      const materials = await getMaterials(filterTripId ? parseInt(filterTripId) : null);
      const trips = await getTrips();
      const tripMap = {};
      trips.forEach(t => tripMap[t.id] = t.name);

      const grid = document.getElementById('materialsGrid');
      const empty = document.getElementById('materialsEmpty');

      if (materials.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      grid.innerHTML = materials.map(m => {
        if (m.type === 'photo') {
          return `
            <div class="material-card">
              <img src="${m.content}" alt="æ—…ã®å†™çœŸ">
              <div class="card-footer">
                <span class="material-type type-photo">ğŸ“¸ å†™çœŸ</span>
                <button class="btn-delete" onclick="removeMaterial(${m.id})">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        } else {
          return `
            <div class="material-card">
              <div class="text-preview">${m.content.substring(0, 100)}${m.content.length > 100 ? '...' : ''}</div>
              <div class="card-footer">
                <span class="material-type type-text">ğŸ’¬ ãƒ†ã‚­ã‚¹ãƒˆ</span>
                <button class="btn-delete" onclick="removeMaterial(${m.id})">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }
      }).join('');
    }

    // ç´ æå‰Šé™¤
    async function removeMaterial(id) {
      if (confirm('ã“ã®ç´ æã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ')) {
        await deleteMaterial(id);
        await renderMaterials();
        showToast('å‰Šé™¤ã—ãŸã‚ˆï¼', 'success');
      }
    }

    // æ—…è¡Œçµ±è¨ˆã‚’æ›´æ–°
    async function updateTripStats() {
      const tripId = document.getElementById('generateTripSelect').value;
      if (!tripId) {
        document.getElementById('photoCount').textContent = '0';
        document.getElementById('textCount').textContent = '0';
        document.getElementById('totalCount').textContent = '0';
        return;
      }

      const materials = await getMaterials(parseInt(tripId));
      const photos = materials.filter(m => m.type === 'photo').length;
      const texts = materials.filter(m => m.type === 'text').length;

      document.getElementById('photoCount').textContent = photos;
      document.getElementById('textCount').textContent = texts;
      document.getElementById('totalCount').textContent = photos + texts;
    }

    document.getElementById('generateTripSelect').addEventListener('change', updateTripStats);

    // ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ
    document.querySelectorAll('.style-option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.style-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
    });

    // ãƒ–ãƒ­ã‚°ç”Ÿæˆ
    async function generateBlog() {
      const tripId = document.getElementById('generateTripSelect').value;
      if (!tripId) {
        showToast('æ—…è¡Œã‚’é¸æŠã—ã¦ã­ï¼', 'error');
        return;
      }

      const trips = await getTrips();
      const trip = trips.find(t => t.id === parseInt(tripId));
      const materials = await getMaterials(parseInt(tripId));

      if (materials.length === 0) {
        showToast('ç´ æãŒãªã„ã‚ˆï¼å…ˆã«è¿½åŠ ã—ã¦ã­', 'error');
        return;
      }

      const style = document.querySelector('.style-option.selected').dataset.style;
      const btn = document.getElementById('generateBtn');
      const btnText = btn.querySelector('.btn-text');
      const loading = btn.querySelector('.loading');

      btn.disabled = true;
      btnText.style.display = 'none';
      loading.classList.add('active');

      try {
        // Claude APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ–ãƒ­ã‚°ç”Ÿæˆ
        const blogContent = await callClaudeAPI(trip, materials, style);
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤º
        document.getElementById('previewFrame').innerHTML = blogContent;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('[data-tab="preview"]').classList.add('active');
        document.getElementById('tab-preview').classList.add('active');

        showToast('ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆã—ãŸã‚ˆï¼ ğŸ‰', 'success');
      } catch (error) {
        console.error('Error generating blog:', error);
        // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç”»é¢ã«è¡¨ç¤º
        document.getElementById('previewFrame').innerHTML = `
          <div style="padding: 1.5rem; background: #FFE0E0; border-radius: 12px;">
            <h3 style="color: #FF6B6B; margin-bottom: 1rem;">ğŸ˜¢ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚ˆ</h3>
            <p style="word-break: break-all;">${error.message}</p>
            <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
              â€» APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­
            </p>
          </div>
        `;
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('[data-tab="preview"]').classList.add('active');
        document.getElementById('tab-preview').classList.add('active');
        showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸ...', 'error');
      } finally {
        btn.disabled = false;
        btnText.style.display = 'inline';
        loading.classList.remove('active');
      }
    }

    // Claude APIå‘¼ã³å‡ºã—
    async function callClaudeAPI(trip, materials, style) {
      const stylePrompts = {
        casual: 'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªå£èª¿ã§ã€å‹é”ã«è©±ã™ã‚ˆã†ã«',
        diary: 'æ—¥è¨˜ã®ã‚ˆã†ãªè¦ªã—ã¿ã‚„ã™ã„ä¸€äººç§°ã§ã€ãã®æ—¥ã®æ„Ÿæƒ³ã‚’äº¤ãˆã¦',
        magazine: 'æ—…è¡Œé›‘èªŒã®è¨˜äº‹ã®ã‚ˆã†ã«ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§é­…åŠ›çš„ã«',
        poetic: 'ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ã§è©©çš„ãªè¡¨ç¾ã‚’ä½¿ã£ã¦ã€æ„Ÿå‹•ã‚’ä¼ãˆã‚‹ã‚ˆã†ã«'
      };

      const texts = materials.filter(m => m.type === 'text').map(m => m.content).join('\n\n');
      const photoCount = materials.filter(m => m.type === 'photo').length;

      // APIã‚­ãƒ¼ã¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
      const apiKey = getApiKey();
      const provider = getProvider();
      
      if (!apiKey) {
        throw new Error('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã­ï¼ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã®å…¥åŠ›æ¬„ã«APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      const prompt = `
ã‚ãªãŸã¯æ—…è¡Œãƒ–ãƒ­ã‚°ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€é­…åŠ›çš„ãªæ—…è¡Œãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’HTMLã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ—…è¡Œåã€‘${trip.name}
ã€æ—¥ä»˜ã€‘${trip.date}
ã€å†™çœŸã®æ•°ã€‘${photoCount}æš
ã€æ—…è¡Œãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³ã€‘
${texts || '(ãƒ¡ãƒ¢ãªã—)'}

ã€æ–‡ç« ã‚¹ã‚¿ã‚¤ãƒ«ã€‘${stylePrompts[style]}

ã€å‡ºåŠ›å½¢å¼ã€‘
- å®Œå…¨ãªHTMLã¯ä¸è¦ã€‚è¨˜äº‹æœ¬æ–‡ã®HTMLã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- è¦‹å‡ºã—ï¼ˆh2, h3ï¼‰ã€æ®µè½ï¼ˆpï¼‰ã€ãƒªã‚¹ãƒˆï¼ˆul, liï¼‰ã‚’é©åˆ‡ã«ä½¿ç”¨
- å†™çœŸã®é…ç½®å ´æ‰€ã¯ [PHOTO_1], [PHOTO_2] ã®ã‚ˆã†ã«è¨˜è¼‰
- èª­ã¿ã‚„ã™ãã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æ¥½ã—ã‚ã‚‹æ§‹æˆã«
- çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ—ã«
- æœ€å¾Œã«ã¾ã¨ã‚ã‚„æ¬¡å›ã¸ã®æœŸå¾…ã‚’å…¥ã‚Œã‚‹
`;

      let response;
      let blogHtml;

      try {
        if (provider === 'openai') {
          // OpenAI API
          response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o',
              max_tokens: 4000,
              messages: [
                { role: 'user', content: prompt }
              ]
            })
          });

          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('OpenAI response parse error:', responseText);
            throw new Error(`OpenAI APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${responseText.substring(0, 100)}`);
          }

          if (!response.ok) {
            throw new Error(data.error?.message || `OpenAI APIã‚¨ãƒ©ãƒ¼ (${response.status})`);
          }

          if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('OpenAI APIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
          }

          blogHtml = data.choices[0].message.content;

        } else {
          // Anthropic API
          response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4000,
              messages: [
                { role: 'user', content: prompt }
              ]
            })
          });

          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Anthropic response parse error:', responseText);
            throw new Error(`Anthropic APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${responseText.substring(0, 100)}`);
          }

          if (!response.ok) {
            throw new Error(data.error?.message || `Anthropic APIã‚¨ãƒ©ãƒ¼ (${response.status})`);
          }

          if (!data.content || !data.content[0] || !data.content[0].text) {
            throw new Error('Anthropic APIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
          }

          blogHtml = data.content[0].text;
        }
      } catch (fetchError) {
        if (fetchError.message.includes('API')) {
          throw fetchError;
        }
        throw new Error(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${fetchError.message}`);
      }

      // å†™çœŸã‚’æŒ¿å…¥
      const photos = materials.filter(m => m.type === 'photo');
      photos.forEach((photo, index) => {
        const placeholder = `[PHOTO_${index + 1}]`;
        const imgTag = `<img src="${photo.content}" alt="æ—…ã®å†™çœŸ${index + 1}" style="max-width:100%; border-radius:12px; margin:1rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">`;
        blogHtml = blogHtml.replace(placeholder, imgTag);
      });

      // ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
      return `
        <style>
          .blog-content { font-family: 'Zen Maru Gothic', sans-serif; line-height: 1.8; color: #2D3436; }
          .blog-content h2 { color: #FF6B6B; margin-top: 2rem; margin-bottom: 1rem; }
          .blog-content h3 { color: #4ECDC4; margin-top: 1.5rem; margin-bottom: 0.75rem; }
          .blog-content p { margin-bottom: 1rem; }
          .blog-content ul { padding-left: 1.5rem; margin-bottom: 1rem; }
          .blog-content li { margin-bottom: 0.5rem; }
        </style>
        <div class="blog-content">
          <h1 style="color: #A66CFF; margin-bottom: 0.5rem;">${trip.name}</h1>
          <p style="color: #888; margin-bottom: 2rem;">ğŸ“… ${trip.date}</p>
          ${blogHtml}
        </div>
      `;
    }

    // ãƒ–ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼
    function copyBlog() {
      const content = document.getElementById('previewFrame').innerText;
      navigator.clipboard.writeText(content).then(() => {
        showToast('ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼ ğŸ“‹', 'success');
      });
    }

    // ãƒ–ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadBlog() {
      const content = document.getElementById('previewFrame').innerHTML;
      const fullHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—…ãƒ–ãƒ­ã‚° - TaviLog</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { max-width: 800px; margin: 0 auto; padding: 2rem; background: #FFF9F0; }
  </style>
</head>
<body>
  ${content}
</body>
</html>`;

      const blob = new Blob([fullHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'travel-blog.html';
      a.click();
      URL.revokeObjectURL(url);
      showToast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚ˆï¼ ğŸ’¾', 'success');
    }

    // ãƒ–ãƒ­ã‚°ã‚’PDFã§å°åˆ·/ä¿å­˜
    function downloadPdf() {
      const content = document.getElementById('previewFrame').innerHTML.trim();
      if (!content) {
        showToast('å…ˆã«ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆã—ã¦ã­ï¼', 'error');
        return;
      }

      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showToast('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ã­', 'error');
        return;
      }

      const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—…ãƒ–ãƒ­ã‚° - PDFå‡ºåŠ›</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    @page { margin: 12mm; }
    body { font-family: 'Zen Maru Gothic', sans-serif; line-height: 1.7; color: #2D3436; }
    h1,h2,h3 { color: #A66CFF; page-break-after: avoid; }
    img { max-width: 100%; border-radius: 10px; margin: 0.5rem 0; page-break-inside: avoid; }
    .blog-content { max-width: 800px; margin: 0 auto; }
  </style>
</head>
<body>
  ${content}
</body>
</html>`;

      printWindow.document.open();
      printWindow.document.write(html);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      setTimeout(() => {
        printWindow.close();
      }, 500);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openNewTripModal() {
      document.getElementById('newTripModal').classList.add('active');
      document.getElementById('tripDateInput').valueAsDate = new Date();
    }

    function closeNewTripModal() {
      document.getElementById('newTripModal').classList.remove('active');
      document.getElementById('tripNameInput').value = '';
    }

    async function createNewTrip() {
      const name = document.getElementById('tripNameInput').value.trim();
      const date = document.getElementById('tripDateInput').value;

      if (!name) {
        showToast('æ—…è¡Œã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼', 'error');
        return;
      }

      const trip = { name, date, createdAt: new Date().toISOString() };
      const newTripId = await addTrip(trip);
      closeNewTripModal();
      await loadTrips(newTripId);
      showToast('æ–°ã—ã„æ—…ã‚’ä½œæˆã—ãŸã‚ˆï¼ ğŸ§³', 'success');
    }

    // æ—…è¡Œä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTrips(selectedTripId = null) {
      const trips = await getTrips();
      const options = trips.map(t => `<option value="${t.id}">${t.name} (${t.date})</option>`).join('');
      const addTabSelect = document.getElementById('tripSelect');
      const materialsSelect = document.getElementById('materialsFilterTrip');
      const generateSelect = document.getElementById('generateTripSelect');

      const targetTripId = selectedTripId ?? addTabSelect.value;
      const targetGenerateTripId = selectedTripId ?? generateSelect.value;
      const targetMaterialsTripId = materialsSelect.value;
      
      addTabSelect.innerHTML = '<option value="">æ—…è¡Œã‚’é¸æŠ...</option>' + options;
      materialsSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®æ—…è¡Œ</option>' + options;
      generateSelect.innerHTML = '<option value="">ç”Ÿæˆã™ã‚‹æ—…è¡Œã‚’é¸æŠ...</option>' + options;

      if (targetTripId && addTabSelect.querySelector(`option[value="${targetTripId}"]`)) {
        addTabSelect.value = String(targetTripId);
      }
      if (targetMaterialsTripId && materialsSelect.querySelector(`option[value="${targetMaterialsTripId}"]`)) {
        materialsSelect.value = String(targetMaterialsTripId);
      }
      if (targetGenerateTripId && generateSelect.querySelector(`option[value="${targetGenerateTripId}"]`)) {
        generateSelect.value = String(targetGenerateTripId);
      }
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // APIã‚­ãƒ¼ãƒ»ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ç®¡ç†
    function getProvider() {
      return localStorage.getItem('tavilog_provider') || 'openai';
    }

    function saveProvider(provider) {
      localStorage.setItem('tavilog_provider', provider);
    }

    function getApiKey() {
      const provider = getProvider();
      return localStorage.getItem(`tavilog_api_key_${provider}`) || '';
    }

    function saveApiKey(key) {
      const provider = getProvider();
      localStorage.setItem(`tavilog_api_key_${provider}`, key);
      updateApiKeyStatus();
    }

    function updateApiKeyStatus() {
      const key = getApiKey();
      const provider = getProvider();
      const status = document.getElementById('apiKeyStatus');
      
      let isValid = false;
      if (provider === 'openai' && key && key.startsWith('sk-')) {
        isValid = true;
      } else if (provider === 'anthropic' && key && key.startsWith('sk-ant-')) {
        isValid = true;
      }
      
      if (isValid) {
        status.textContent = 'âœ“ è¨­å®šæ¸ˆã¿';
        status.className = 'api-key-status valid';
      } else if (key) {
        status.textContent = 'å½¢å¼ç¢ºèª';
        status.className = 'api-key-status invalid';
      } else {
        status.textContent = 'æœªè¨­å®š';
        status.className = 'api-key-status invalid';
      }
    }

    // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('aiProvider').addEventListener('change', (e) => {
      saveProvider(e.target.value);
      // ä¿å­˜æ¸ˆã¿ã®APIã‚­ãƒ¼ã‚’å¾©å…ƒ
      const savedKey = getApiKey();
      document.getElementById('apiKeyInput').value = savedKey;
      updateApiKeyStatus();
      const providerName = e.target.value === 'openai' ? 'ChatGPT' : 'Claude';
      showToast(`${providerName}ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚ˆï¼`, 'success');
    });

    // APIã‚­ãƒ¼å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('apiKeyInput').addEventListener('change', (e) => {
      saveApiKey(e.target.value);
      showToast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ãŸã‚ˆï¼ ğŸ”‘', 'success');
    });

    document.getElementById('apiKeyInput').addEventListener('input', (e) => {
      const key = e.target.value;
      const provider = getProvider();
      const status = document.getElementById('apiKeyStatus');
      
      let isValid = false;
      if (provider === 'openai' && key && key.startsWith('sk-')) {
        isValid = true;
      } else if (provider === 'anthropic' && key && key.startsWith('sk-ant-')) {
        isValid = true;
      }
      
      if (isValid) {
        status.textContent = 'âœ“ æœ‰åŠ¹';
        status.className = 'api-key-status valid';
      } else if (key) {
        status.textContent = 'å½¢å¼ç¢ºèª';
        status.className = 'api-key-status invalid';
      } else {
        status.textContent = 'æœªè¨­å®š';
        status.className = 'api-key-status invalid';
      }
    });

    // ========== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š ==========
    
    function getStorageType() {
      return localStorage.getItem('tavilog_storage_type') || 'local';
    }

    function changeStorageType(type) {
      localStorage.setItem('tavilog_storage_type', type);
      const gdriveSettings = document.getElementById('gdriveSettings');
      if (type === 'gdrive') {
        gdriveSettings.style.display = 'block';
        updateGdriveStatus();
      } else {
        gdriveSettings.style.display = 'none';
      }
      showToast(type === 'gdrive' ? 'Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' : 'ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ', 'success');
    }

    // ========== Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æº ==========
    
    let gapi = null;
    let tokenClient = null;
    let gapiInited = false;
    let gisInited = false;

    function getGdriveClientId() {
      return localStorage.getItem('tavilog_gdrive_client_id') || '';
    }

    function saveGdriveClientId(clientId) {
      localStorage.setItem('tavilog_gdrive_client_id', clientId);
    }

    function isGdriveConnected() {
      return localStorage.getItem('tavilog_gdrive_connected') === 'true';
    }

    function updateGdriveStatus() {
      const status = document.getElementById('gdriveStatus');
      const connectBtn = document.getElementById('gdriveConnectBtn');
      const disconnectBtn = document.getElementById('gdriveDisconnectBtn');
      
      if (isGdriveConnected()) {
        status.innerHTML = '<span class="status-icon">âœ…</span><span class="status-text">æ¥ç¶šæ¸ˆã¿</span>';
        status.className = 'gdrive-status connected';
        connectBtn.style.display = 'none';
        disconnectBtn.style.display = 'inline-block';
      } else {
        status.innerHTML = '<span class="status-icon">âŒ</span><span class="status-text">æœªæ¥ç¶š</span>';
        status.className = 'gdrive-status disconnected';
        connectBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'none';
      }
    }

    async function connectGoogleDrive() {
      const clientId = document.getElementById('gdriveClientId').value.trim();
      
      if (!clientId) {
        showToast('Client IDã‚’å…¥åŠ›ã—ã¦ã­ï¼', 'error');
        return;
      }

      if (!clientId.includes('.apps.googleusercontent.com')) {
        showToast('Client IDã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆ', 'error');
        return;
      }

      saveGdriveClientId(clientId);

      // Google API ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
      try {
        await loadGoogleApi();
        await initGoogleAuth(clientId);
        showToast('Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«æ¥ç¶šã—ãŸã‚ˆï¼ â˜ï¸', 'success');
      } catch (error) {
        console.error('Google Drive connection error:', error);
        showToast('æ¥ç¶šã«å¤±æ•—...è¨­å®šã‚’ç¢ºèªã—ã¦ã­', 'error');
      }
    }

    function loadGoogleApi() {
      return new Promise((resolve, reject) => {
        if (window.gapi) {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://apis.google.com/js/api.js';
        script.onload = () => {
          gapi = window.gapi;
          gapi.load('client', async () => {
            await gapi.client.init({
              discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            gapiInited = true;
            resolve();
          });
        };
        script.onerror = reject;
        document.body.appendChild(script);

        // Google Identity Services
        const gisScript = document.createElement('script');
        gisScript.src = 'https://accounts.google.com/gsi/client';
        gisScript.onload = () => {
          gisInited = true;
        };
        document.body.appendChild(gisScript);
      });
    }

    async function initGoogleAuth(clientId) {
      return new Promise((resolve, reject) => {
        // å¾…æ©Ÿ
        const checkReady = setInterval(() => {
          if (gapiInited && window.google) {
            clearInterval(checkReady);
            
            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: clientId,
              scope: 'https://www.googleapis.com/auth/drive.file',
              callback: (response) => {
                if (response.error) {
                  reject(response);
                  return;
                }
                localStorage.setItem('tavilog_gdrive_connected', 'true');
                updateGdriveStatus();
                syncToGoogleDrive();
                resolve();
              },
            });

            tokenClient.requestAccessToken({ prompt: 'consent' });
          }
        }, 100);

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        setTimeout(() => {
          clearInterval(checkReady);
          reject(new Error('Timeout'));
        }, 30000);
      });
    }

    function disconnectGoogleDrive() {
      if (confirm('Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¨ã®æ¥ç¶šã‚’è§£é™¤ã™ã‚‹ï¼Ÿ\nãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚‹ã‚ˆã€‚')) {
        localStorage.removeItem('tavilog_gdrive_connected');
        if (window.google && google.accounts && google.accounts.oauth2) {
          google.accounts.oauth2.revoke(gapi.client.getToken()?.access_token);
        }
        updateGdriveStatus();
        showToast('æ¥ç¶šã‚’è§£é™¤ã—ãŸã‚ˆ', 'success');
      }
    }

    async function syncToGoogleDrive() {
      if (!isGdriveConnected() || getStorageType() !== 'gdrive') return;

      try {
        const trips = await getTrips();
        const materials = await getMaterials();
        const data = { trips, materials, exportedAt: new Date().toISOString() };

        // TaviLogãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¢ã™ã‹ä½œæˆ
        let folderId = localStorage.getItem('tavilog_gdrive_folder_id');
        
        if (!folderId) {
          // ãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢
          const folderResponse = await gapi.client.drive.files.list({
            q: "name='TaviLog' and mimeType='application/vnd.google-apps.folder' and trashed=false",
            fields: 'files(id, name)'
          });

          if (folderResponse.result.files.length > 0) {
            folderId = folderResponse.result.files[0].id;
          } else {
            // ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
            const createResponse = await gapi.client.drive.files.create({
              resource: {
                name: 'TaviLog',
                mimeType: 'application/vnd.google-apps.folder'
              },
              fields: 'id'
            });
            folderId = createResponse.result.id;
          }
          localStorage.setItem('tavilog_gdrive_folder_id', folderId);
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã¾ãŸã¯ä½œæˆ
        let fileId = localStorage.getItem('tavilog_gdrive_file_id');
        const fileContent = JSON.stringify(data);
        const blob = new Blob([fileContent], { type: 'application/json' });

        if (fileId) {
          // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
          await gapi.client.request({
            path: `/upload/drive/v3/files/${fileId}`,
            method: 'PATCH',
            params: { uploadType: 'media' },
            body: fileContent
          });
        } else {
          // æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          const metadata = {
            name: 'tavilog-data.json',
            parents: [folderId]
          };

          const form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          form.append('file', blob);

          const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${gapi.client.getToken().access_token}`
            },
            body: form
          });
          const result = await response.json();
          localStorage.setItem('tavilog_gdrive_file_id', result.id);
        }

        console.log('Synced to Google Drive');
      } catch (error) {
        console.error('Google Drive sync error:', error);
      }
    }

    async function loadFromGoogleDrive() {
      if (!isGdriveConnected() || getStorageType() !== 'gdrive') return;

      try {
        const fileId = localStorage.getItem('tavilog_gdrive_file_id');
        if (!fileId) return;

        const response = await gapi.client.drive.files.get({
          fileId: fileId,
          alt: 'media'
        });

        const data = response.result;
        if (data.trips && data.materials) {
          // ãƒ­ãƒ¼ã‚«ãƒ«DBã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          for (const trip of data.trips) {
            await addTrip(trip);
          }
          for (const material of data.materials) {
            await addMaterial(material);
          }
          await loadTrips();
          showToast('Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã ã‚ˆï¼', 'success');
        }
      } catch (error) {
        console.error('Load from Google Drive error:', error);
      }
    }

    // ========== ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ==========

    async function exportData() {
      try {
        const trips = await getTrips();
        const materials = await getMaterials();
        const data = {
          trips,
          materials,
          exportedAt: new Date().toISOString(),
          version: '1.0'
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tavilog-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã‚ˆï¼ ğŸ“¤', 'success');
      } catch (error) {
        showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—...', 'error');
      }
    }

    async function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data.trips || !data.materials) {
          throw new Error('Invalid format');
        }

        if (!confirm(`${data.trips.length}ä»¶ã®æ—…è¡Œã¨${data.materials.length}ä»¶ã®ç´ æã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã‚‹ã‚ˆã€‚`)) {
          return;
        }

        for (const trip of data.trips) {
          const { id, ...tripData } = trip; // idã‚’é™¤å¤–
          await addTrip(tripData);
        }

        for (const material of data.materials) {
          const { id, ...materialData } = material;
          await addMaterial(materialData);
        }

        await loadTrips();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã‚ˆï¼ ğŸ“¥', 'success');
      } catch (error) {
        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—...ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ã­', 'error');
      }

      event.target.value = '';
    }

    async function clearAllData() {
      if (!confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ãªã„ã‚ˆï¼')) {
        return;
      }

      if (!confirm('æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«å‰Šé™¤ã—ã¦ã„ã„ï¼Ÿ')) {
        return;
      }

      try {
        const transaction = db.transaction(['trips', 'materials', 'blogs'], 'readwrite');
        transaction.objectStore('trips').clear();
        transaction.objectStore('materials').clear();
        transaction.objectStore('blogs').clear();

        await new Promise((resolve, reject) => {
          transaction.oncomplete = resolve;
          transaction.onerror = reject;
        });

        await loadTrips();
        showToast('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ãŸã‚ˆ', 'success');
      } catch (error) {
        showToast('å‰Šé™¤ã«å¤±æ•—...', 'error');
      }
    }

    // ========== åˆæœŸåŒ– ==========
    
    initDB().then(() => {
      loadTrips();
      
      // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨APIã‚­ãƒ¼ã‚’å¾©å…ƒ
      const savedProvider = getProvider();
      document.getElementById('aiProvider').value = savedProvider;
      const savedKey = getApiKey();
      if (savedKey) {
        document.getElementById('apiKeyInput').value = savedKey;
      }
      updateApiKeyStatus();

      // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šã‚’å¾©å…ƒ
      const storageType = getStorageType();
      document.querySelector(`input[name="storageType"][value="${storageType}"]`).checked = true;
      if (storageType === 'gdrive') {
        document.getElementById('gdriveSettings').style.display = 'block';
        const savedClientId = getGdriveClientId();
        if (savedClientId) {
          document.getElementById('gdriveClientId').value = savedClientId;
        }
        updateGdriveStatus();
      }

      // ç¾åœ¨ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¨­å®šã‚¬ã‚¤ãƒ‰ã«è¡¨ç¤º
      const originEl = document.getElementById('currentOrigin');
      if (originEl) {
        originEl.textContent = window.location.origin || 'file://ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰';
      }

      console.log('TaviLog initialized! ğŸš€');
    });
  </script>
</body>
</html>
