<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaviLog - æ—…ã®è¨˜éŒ²ã‚’ãƒ–ãƒ­ã‚°ã«</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #FF6B6B;
      --secondary: #4ECDC4;
      --accent: #FFE66D;
      --purple: #A66CFF;
      --bg: #FFF9F0;
      --card: #FFFFFF;
      --text: #2D3436;
      --text-light: #636E72;
      --shadow: 0 8px 32px rgba(255, 107, 107, 0.15);
      --shadow-hover: 0 12px 48px rgba(255, 107, 107, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Zen Maru Gothic', 'Quicksand', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      right: -30%;
      width: 80%;
      height: 80%;
      background: radial-gradient(circle, rgba(78, 205, 196, 0.1) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    body::after {
      content: '';
      position: fixed;
      bottom: -30%;
      left: -20%;
      width: 60%;
      height: 60%;
      background: radial-gradient(circle, rgba(255, 107, 107, 0.08) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      padding: 2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: 'âœˆï¸ ğŸ—ºï¸ ğŸ“¸ ğŸŒ´ â›©ï¸ ğŸ”ï¸';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 8rem;
      opacity: 0.1;
      white-space: nowrap;
      pointer-events: none;
    }

    .logo {
      font-family: 'Quicksand', sans-serif;
      font-size: 3rem;
      font-weight: 700;
      color: white;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
      position: relative;
      display: inline-block;
    }

    .logo span {
      color: var(--accent);
    }

    .tagline {
      color: rgba(255,255,255,0.9);
      margin-top: 0.5rem;
      font-size: 1.1rem;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .tab-btn {
      flex: 1;
      min-width: 150px;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 20px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--card);
      color: var(--text-light);
      box-shadow: var(--shadow);
    }

    .tab-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      color: white;
    }

    .tab-btn .icon {
      margin-right: 0.5rem;
    }

    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ç´ æè¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .add-section {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* æ—…è¡Œé¸æŠãƒ»ä½œæˆ */
    .trip-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .trip-select {
      flex: 1;
      min-width: 200px;
      padding: 1rem;
      border: 2px solid #E0E0E0;
      border-radius: 16px;
      font-family: inherit;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .trip-select:focus {
      outline: none;
      border-color: var(--secondary);
    }

    .btn-new-trip {
      padding: 1rem 2rem;
      border: 2px dashed var(--secondary);
      border-radius: 16px;
      background: rgba(78, 205, 196, 0.1);
      color: var(--secondary);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-new-trip:hover {
      background: var(--secondary);
      color: white;
      border-style: solid;
    }

    .btn-delete-trip {
      padding: 0.8rem 1rem;
      border: none;
      border-radius: 12px;
      background: rgba(255, 107, 107, 0.1);
      color: var(--primary);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete-trip:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
    }

    /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
    .dropzone {
      border: 3px dashed #DDD;
      border-radius: 20px;
      padding: 3rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, rgba(255,107,107,0.03) 0%, rgba(78,205,196,0.03) 100%);
      margin-bottom: 1.5rem;
    }

    .dropzone:hover,
    .dropzone.dragover {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(255,107,107,0.08) 0%, rgba(78,205,196,0.08) 100%);
      transform: scale(1.01);
    }

    .dropzone-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .dropzone-text {
      font-size: 1.2rem;
      color: var(--text-light);
    }

    .dropzone-hint {
      font-size: 0.9rem;
      color: #AAA;
      margin-top: 0.5rem;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› */
    .text-input-area {
      margin-top: 1.5rem;
    }

    .text-input {
      width: 100%;
      min-height: 120px;
      padding: 1.5rem;
      border: 2px solid #E0E0E0;
      border-radius: 16px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      transition: border-color 0.3s;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--secondary);
    }

    .text-input::placeholder {
      color: #BBB;
    }

    .btn-add-text {
      margin-top: 1rem;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, var(--secondary) 0%, #45B7AA 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-add-text:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(78, 205, 196, 0.4);
    }

    /* ç´ æä¸€è¦§ */
    .materials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .material-card {
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s;
      position: relative;
    }

    .material-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }

    .material-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .material-card .text-preview {
      padding: 1rem;
      font-size: 0.9rem;
      color: var(--text-light);
      height: 150px;
      overflow: hidden;
      background: linear-gradient(135deg, rgba(255,230,109,0.2) 0%, rgba(166,108,255,0.1) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .material-card .card-footer {
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #F0F0F0;
    }

    .material-type {
      font-size: 0.8rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-weight: 600;
    }

    .type-photo {
      background: rgba(255, 107, 107, 0.15);
      color: var(--primary);
    }

    .type-text {
      background: rgba(78, 205, 196, 0.15);
      color: var(--secondary);
    }

    .btn-delete {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.3s;
    }

    .btn-delete:hover {
      opacity: 1;
    }

    /* ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .generate-section {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .trip-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(166,108,255,0.1) 100%);
      padding: 1.5rem;
      border-radius: 16px;
      text-align: center;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }

    .generate-options {
      margin-bottom: 2rem;
    }

    .option-group {
      margin-bottom: 1.5rem;
    }

    .option-label {
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: block;
    }

    .style-options {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .style-option {
      padding: 0.75rem 1.5rem;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      background: white;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s;
    }

    .style-option:hover {
      border-color: var(--primary);
    }

    .style-option.selected {
      border-color: var(--primary);
      background: rgba(255, 107, 107, 0.1);
      color: var(--primary);
      font-weight: 600;
    }

    .btn-generate {
      width: 100%;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      color: white;
      border: none;
      border-radius: 16px;
      font-family: inherit;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(255, 107, 107, 0.4);
    }

    .btn-generate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* ãƒ–ãƒ­ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .preview-section {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .preview-header .section-title {
      flex: 1 1 100%;
      margin-bottom: 0;
    }

    @media (min-width: 769px) {
      .preview-header .section-title {
        flex: 0 1 auto;
      }
    }

    .preview-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn-action {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-copy {
      background: var(--secondary);
      color: white;
    }

    .btn-download {
      background: var(--purple);
      color: white;
    }

    .btn-action:hover {
      transform: translateY(-2px);
    }

    .preview-frame {
      border: 1px solid #E0E0E0;
      border-radius: 16px;
      min-height: 400px;
      padding: 2rem;
      background: white;
    }

    .preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: var(--text-light);
    }

    .preview-placeholder-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* APIã‚­ãƒ¼è¨­å®šãƒãƒ¼ */
    .api-key-bar {
      background: linear-gradient(135deg, #2D3436 0%, #636E72 100%);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .api-key-bar label {
      color: white;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .ai-select {
      padding: 0.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      background: white;
      cursor: pointer;
    }

    .api-key-input {
      flex: 1;
      min-width: 120px;
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.8rem;
    }

    .api-key-status {
      padding: 0.4rem 0.6rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .api-key-status.valid {
      background: rgba(78, 205, 196, 0.2);
      color: #4ECDC4;
    }

    .api-key-status.invalid {
      background: rgba(255, 107, 107, 0.2);
      color: #FF6B6B;
    }

    .api-help-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .api-help-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: scale(1.1);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--card);
      border-radius: 24px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }

    .modal-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--secondary);
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn-modal {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: #E0E0E0;
      color: var(--text);
    }

    .btn-confirm {
      background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
      color: white;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 2rem;
      background: var(--text);
      color: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--secondary);
    }

    .toast.error {
      background: var(--primary);
    }

    /* è¨­å®šã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .settings-group {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #E0E0E0;
    }

    .settings-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-subtitle {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text);
    }

    .data-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn-data-action {
      padding: 0.75rem 1rem;
      background: white;
      border: 2px solid #E0E0E0;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-data-action:hover {
      border-color: var(--secondary);
      background: rgba(78, 205, 196, 0.05);
    }

    .btn-data-action.btn-danger {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-data-action.btn-danger:hover {
      background: rgba(255, 107, 107, 0.1);
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .photo-block-wrapper {
      position: relative;
      margin: 1rem 0;
    }

    .photo-edit-controls {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      gap: 0.25rem;
      z-index: 10;
    }

    .edit-mode .photo-edit-controls {
      display: flex;
    }

    .photo-edit-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .photo-edit-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .photo-edit-btn.btn-up { background: rgba(78, 205, 196, 0.9); }
    .photo-edit-btn.btn-down { background: rgba(78, 205, 196, 0.9); }
    .photo-edit-btn.btn-delete { background: rgba(255, 107, 107, 0.9); }

    .photo-edit-btn.btn-up:hover { background: rgba(78, 205, 196, 1); }
    .photo-edit-btn.btn-down:hover { background: rgba(78, 205, 196, 1); }
    .photo-edit-btn.btn-delete:hover { background: rgba(255, 107, 107, 1); }

    .edit-mode .blog-content h1,
    .edit-mode .blog-content h2,
    .edit-mode .blog-content h3,
    .edit-mode .blog-content p {
      outline: none;
      transition: background 0.2s;
    }

    .edit-mode .blog-content h1:focus,
    .edit-mode .blog-content h2:focus,
    .edit-mode .blog-content h3:focus,
    .edit-mode .blog-content p:focus {
      background: rgba(255, 230, 109, 0.15);
      border-radius: 4px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .logo {
        font-size: 2rem;
      }

      .tabs {
        gap: 0.5rem;
      }

      .tab-btn {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        min-width: auto;
      }

      .dropzone {
        padding: 2rem;
      }

      .dropzone-icon {
        font-size: 3rem;
      }

      .materials-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }

      /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ - ã‚¹ãƒãƒ›å¯¾å¿œ */
      .preview-actions {
        width: 100%;
        flex-wrap: wrap;
      }

      .btn-action {
        font-size: 0.85rem;
        padding: 0.6rem 1rem;
        flex: 1;
        min-width: 100px;
      }

      /* ç·¨é›†ãƒœã‚¿ãƒ³ - ã‚¹ãƒãƒ›å¯¾å¿œ */
      .photo-edit-btn {
        width: 48px;
        height: 48px;
        font-size: 1.4rem;
      }

      .photo-edit-controls {
        gap: 0.5rem;
      }

      /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ */
      .photo-edit-btn:active {
        transform: scale(0.95);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 class="logo">Tavi<span>Log</span></h1>
    <p class="tagline">æ—…ã®æ€ã„å‡ºã‚’ã€ç´ æ•µãªãƒ–ãƒ­ã‚°ã« âœ¨</p>
  </header>

  <!-- APIã‚­ãƒ¼è¨­å®šãƒãƒ¼ -->
  <div class="api-key-bar">
    <label>ğŸ¤– AI:</label>
    <select id="aiProvider" class="ai-select">
      <option value="google">Gemini (Google) ğŸ†“</option>
      <option value="openai">ChatGPT (OpenAI)</option>
      <option value="anthropic">Claude (Anthropic)</option>
    </select>
    <label>ğŸ”‘</label>
    <input type="password" class="api-key-input" id="apiKeyInput" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›...">
    <span class="api-key-status invalid" id="apiKeyStatus">æœªè¨­å®š</span>
    <button class="api-help-btn" onclick="openApiHelpModal()" title="APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•">â“</button>
  </div>

  <div class="container">
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="add">
        <span class="icon">ğŸ“</span>ç´ æã‚’è¿½åŠ 
      </button>
      <button class="tab-btn" data-tab="materials">
        <span class="icon">ğŸ“¦</span>ç´ æä¸€è¦§
      </button>
      <button class="tab-btn" data-tab="generate">
        <span class="icon">âœ¨</span>ãƒ–ãƒ­ã‚°ç”Ÿæˆ
      </button>
      <button class="tab-btn" data-tab="preview">
        <span class="icon">ğŸ‘€</span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      </button>
      <button class="tab-btn" data-tab="settings">
        <span class="icon">âš™ï¸</span>è¨­å®š
      </button>
    </nav>

    <!-- ç´ æè¿½åŠ ã‚¿ãƒ– -->
    <div id="tab-add" class="tab-content active">
      <div class="add-section">
        <h2 class="section-title">ğŸ§³ æ—…ã‚’é¸ã‚“ã§ç´ æã‚’è¿½åŠ </h2>
        
        <div class="trip-selector">
          <select id="tripSelect" class="trip-select">
            <option value="">æ—…è¡Œã‚’é¸æŠ...</option>
          </select>
          <button class="btn-new-trip" onclick="openNewTripModal()">
            â• æ–°ã—ã„æ—…ã‚’ä½œæˆ
          </button>
          <button class="btn-delete-trip" onclick="deleteTripWithConfirm()" title="é¸æŠä¸­ã®æ—…ã‚’å‰Šé™¤">
            ğŸ—‘ï¸
          </button>
        </div>

        <div class="dropzone" id="dropzone">
          <div class="dropzone-icon">ğŸ“¸</div>
          <p class="dropzone-text">å†™çœŸã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
          <p class="dropzone-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
          <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
        </div>

        <div class="text-input-area">
          <textarea 
            class="text-input" 
            id="textInput" 
            placeholder="æ—…ã®æ€ã„å‡ºã‚„ãƒ¡ãƒ¢ã‚’è‡ªç”±ã«æ›¸ã„ã¦ã­ ğŸ–Šï¸&#10;&#10;ä¾‹ï¼š&#10;ãƒ»ä»Šæ—¥ã¯ç®±æ ¹ã®æ¸©æ³‰ã«è¡Œã£ãŸï¼éœ²å¤©é¢¨å‘‚ã‹ã‚‰è¦‹ãŸå¯Œå£«å±±ãŒæœ€é«˜ã ã£ãŸã€‚&#10;ãƒ»ãƒ©ãƒ³ãƒã¯é»’ãŸã¾ã”é£Ÿã¹ãŸã€‚æ„å¤–ã¨ãŠã„ã—ã„ç¬‘"></textarea>
          <button class="btn-add-text" onclick="addTextMaterial()">
            ğŸ’¬ ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
          </button>
        </div>
      </div>
    </div>

    <!-- ç´ æä¸€è¦§ã‚¿ãƒ– -->
    <div id="tab-materials" class="tab-content">
      <div class="add-section">
        <h2 class="section-title">ğŸ“¦ ä¿å­˜ã•ã‚ŒãŸç´ æ</h2>
        
        <div class="trip-selector">
          <select id="materialsFilterTrip" class="trip-select" onchange="renderMaterials()">
            <option value="">ã™ã¹ã¦ã®æ—…è¡Œ</option>
          </select>
        </div>

        <div id="materialsGrid" class="materials-grid">
          <!-- ç´ æã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å…¥ã‚‹ -->
        </div>

        <div id="materialsEmpty" class="empty-state" style="display:none;">
          <div class="empty-icon">ğŸ–ï¸</div>
          <p>ã¾ã ç´ æãŒãªã„ã‚ˆï¼<br>å†™çœŸã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã¿ã‚ˆã†</p>
        </div>
      </div>
    </div>

    <!-- ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚¿ãƒ– -->
    <div id="tab-generate" class="tab-content">
      <div class="generate-section">
        <h2 class="section-title">âœ¨ ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆ</h2>

        <div class="trip-selector">
          <select id="generateTripSelect" class="trip-select">
            <option value="">ç”Ÿæˆã™ã‚‹æ—…è¡Œã‚’é¸æŠ...</option>
          </select>
        </div>

        <div class="trip-stats" id="tripStats">
          <div class="stat-card">
            <div class="stat-number" id="photoCount">0</div>
            <div class="stat-label">å†™çœŸ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="textCount">0</div>
            <div class="stat-label">ãƒ†ã‚­ã‚¹ãƒˆ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">åˆè¨ˆç´ æ</div>
          </div>
        </div>

        <div class="generate-options">
          <div class="option-group">
            <label class="option-label">ğŸ“ æ–‡ç« ã®ã‚¹ã‚¿ã‚¤ãƒ«</label>
            <div class="style-options">
              <button class="style-option selected" data-style="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</button>
              <button class="style-option" data-style="diary">æ—¥è¨˜é¢¨</button>
              <button class="style-option" data-style="magazine">æ—…è¡Œé›‘èªŒé¢¨</button>
              <button class="style-option" data-style="poetic">ã‚¨ãƒ¢ã„æ„Ÿã˜</button>
            </div>
          </div>
        </div>

        <button class="btn-generate" id="generateBtn" onclick="generateBlog()">
          <span class="btn-text">ğŸš€ ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆã™ã‚‹</span>
          <div class="loading">
            <div class="spinner"></div>
            <span>ç”Ÿæˆä¸­...</span>
          </div>
        </button>
      </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
    <div id="tab-preview" class="tab-content">
      <div class="preview-section">
        <div class="preview-header">
          <h2 class="section-title">ğŸ‘€ ãƒ–ãƒ­ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
          <div class="preview-actions">
            <button class="btn-action btn-edit" id="editModeBtn" onclick="toggleEditMode()" style="background: linear-gradient(135deg, #FFE66D, #FFA500); color: #2D3436;">âœï¸ ç·¨é›†</button>
            <button class="btn-action btn-save" onclick="saveCurrentBlog()" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white;">ğŸ’– ãŠæ°—ã«å…¥ã‚Šä¿å­˜</button>
            <button class="btn-action btn-copy" onclick="copyBlog()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button class="btn-action btn-download" onclick="downloadBlog()">ğŸ’¾ HTMLä¿å­˜</button>
          </div>
        </div>

        <div class="preview-frame" id="previewFrame">
          <div class="preview-placeholder">
            <div class="preview-placeholder-icon">ğŸ“</div>
            <p>ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          </div>
        </div>

        <!-- ä¿å­˜æ¸ˆã¿ãƒ–ãƒ­ã‚°ä¸€è¦§ -->
        <div class="saved-blogs-section" style="margin-top: 2rem;">
          <h3 class="section-title" style="font-size: 1.1rem;">ğŸ’– ä¿å­˜ã—ãŸãƒ–ãƒ­ã‚°</h3>
          <div id="savedBlogsList" class="saved-blogs-list" style="display: grid; gap: 0.75rem; margin-top: 1rem;"></div>
        </div>
      </div>
    </div>

    <!-- è¨­å®šã‚¿ãƒ– -->
    <div id="tab-settings" class="tab-content">
      <div class="add-section">
        <h2 class="section-title">âš™ï¸ è¨­å®š</h2>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="settings-group">
          <h3 class="settings-subtitle">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
          <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã¨å…±æœ‰ã™ã‚‹ã«ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã­ã€‚</p>
          <div class="data-actions">
            <button class="btn-data-action" onclick="exportData()">
              ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button class="btn-data-action" onclick="document.getElementById('importFile').click()">
              ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            </button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            <button class="btn-data-action btn-danger" onclick="clearAllData()">
              ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- æ–°è¦æ—…è¡Œãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="newTripModal">
    <div class="modal">
      <h3 class="modal-title">ğŸ§³ æ–°ã—ã„æ—…ã‚’ä½œæˆ</h3>
      <input type="text" class="modal-input" id="tripNameInput" placeholder="æ—…è¡Œã®åå‰ï¼ˆä¾‹ï¼šç®±æ ¹æ¸©æ³‰æ—…è¡Œ2024ï¼‰">
      <input type="date" class="modal-input" id="tripDateInput">
      <div class="modal-actions">
        <button class="btn-modal btn-cancel" onclick="closeNewTripModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-modal btn-confirm" onclick="createNewTrip()">ä½œæˆ</button>
      </div>
    </div>
  </div>

  <!-- APIã‚­ãƒ¼ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="apiHelpModal">
    <div class="modal" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
      <h3 class="modal-title">ğŸ”‘ APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•</h3>
      <div style="text-align: left; line-height: 1.8;">
        <div id="googleHelp" style="background: rgba(78, 205, 196, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
          <h4 style="color: var(--secondary); margin: 0 0 0.5rem;">ğŸŒŸ Gemini (Google) ã®å ´åˆã€ãŠã™ã™ã‚ãƒ»ç„¡æ–™æ ã‚ã‚Šã€‘</h4>
          <ol style="padding-left: 1.5rem; margin: 0.5rem 0;">
            <li><a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--secondary);">Google AI Studio</a>ã«Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</li>
            <li>ã€ŒAPIã‚­ãƒ¼ã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li>ä½œæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</li>
            <li>ä¸Šã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ âœ¨</li>
          </ol>
          <p style="font-size: 0.85rem; color: var(--secondary); margin-top: 0.5rem; font-weight: bold;">
            ğŸ‰ ç„¡æ–™æ ã‚ã‚Šï¼ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ä¸è¦ã§å§‹ã‚ã‚‰ã‚Œã¾ã™
          </p>
        </div>

        <div id="openaiHelp">
          <h4 style="color: var(--primary); margin: 1rem 0 0.5rem;">ChatGPT (OpenAI) ã®å ´åˆ</h4>
          <ol style="padding-left: 1.5rem; margin: 0.5rem 0;">
            <li><a href="https://platform.openai.com/signup" target="_blank" style="color: var(--secondary);">OpenAIã®ã‚µã‚¤ãƒˆ</a>ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</li>
            <li>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€å³ä¸Šã®ã‚¢ã‚¤ã‚³ãƒ³ â†’ ã€ŒAPI keysã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li>ã€ŒCreate new secret keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li>ä½œæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆsk-ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ï¼‰</li>
            <li>ä¸Šã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ âœ¨</li>
          </ol>
          <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
            ğŸ’¡ åˆå›ã¯é›»è©±ç•ªå·èªè¨¼ã¨ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç™»éŒ²ãŒå¿…è¦ã§ã™ï¼ˆå¾“é‡èª²é‡‘ï¼‰
          </p>
        </div>
        
        <div id="anthropicHelp">
          <h4 style="color: var(--purple); margin: 1rem 0 0.5rem;">Claude (Anthropic) ã®å ´åˆ</h4>
          <ol style="padding-left: 1.5rem; margin: 0.5rem 0;">
            <li><a href="https://console.anthropic.com/" target="_blank" style="color: var(--secondary);">Anthropicã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</a>ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</li>
            <li>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã€ŒAPI Keysã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li>ã€ŒCreate Keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li>ä½œæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆsk-ant-ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ï¼‰</li>
            <li>ä¸Šã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ âœ¨</li>
          </ol>
          <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
            ğŸ’¡ ã“ã¡ã‚‰ã‚‚ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç™»éŒ²ãŒå¿…è¦ã§ã™ï¼ˆå¾“é‡èª²é‡‘ï¼‰
          </p>
        </div>

        <div style="background: rgba(166, 108, 255, 0.1); padding: 1rem; border-radius: 12px; margin-top: 1rem;">
          <p style="font-size: 0.9rem; margin: 0;">
            <strong>ğŸ’° æ–™é‡‘ã®ç›®å®‰ï¼ˆæœ‰æ–™ãƒ—ãƒ©ãƒ³ã®å ´åˆï¼‰</strong><br>
            ãƒ–ãƒ­ã‚°1å›ç”Ÿæˆã§ç´„ 5ã€œ20å†† ç¨‹åº¦ã§ã™ã€‚<br>
            å†™çœŸã®æšæ•°ã‚„ãƒ–ãƒ­ã‚°ã®é•·ã•ã«ã‚ˆã£ã¦å¤‰ã‚ã‚Šã¾ã™ã€‚
          </p>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal btn-confirm" onclick="closeApiHelpModal()">ã‚ã‹ã£ãŸï¼</button>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="toast" id="toast"></div>

  <script>
    // IndexedDBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    const DB_NAME = 'TaviLogDB';
    const DB_VERSION = 1;
    let db;

    // DBåˆæœŸåŒ–
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // æ—…è¡Œã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains('trips')) {
            const tripStore = db.createObjectStore('trips', { keyPath: 'id', autoIncrement: true });
            tripStore.createIndex('name', 'name', { unique: false });
            tripStore.createIndex('date', 'date', { unique: false });
          }
          
          // ç´ æã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains('materials')) {
            const materialStore = db.createObjectStore('materials', { keyPath: 'id', autoIncrement: true });
            materialStore.createIndex('tripId', 'tripId', { unique: false });
            materialStore.createIndex('type', 'type', { unique: false });
            materialStore.createIndex('createdAt', 'createdAt', { unique: false });
          }
          
          // ç”Ÿæˆã•ã‚ŒãŸãƒ–ãƒ­ã‚°ã‚¹ãƒˆã‚¢
          if (!db.objectStoreNames.contains('blogs')) {
            const blogStore = db.createObjectStore('blogs', { keyPath: 'id', autoIncrement: true });
            blogStore.createIndex('tripId', 'tripId', { unique: false });
          }
        };
      });
    }

    // æ—…è¡Œã‚’å–å¾—
    async function getTrips() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['trips'], 'readonly');
        const store = transaction.objectStore('trips');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // æ—…è¡Œã‚’è¿½åŠ 
    async function addTrip(trip) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['trips'], 'readwrite');
        const store = transaction.objectStore('trips');
        const request = store.add(trip);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // æ—…è¡Œã‚’å‰Šé™¤ï¼ˆé–¢é€£ã™ã‚‹ç´ æã¨ãƒ–ãƒ­ã‚°ã‚‚å‰Šé™¤ï¼‰
    async function deleteTrip(tripId) {
      return new Promise(async (resolve, reject) => {
        try {
          // æ—…è¡Œã‚’å‰Šé™¤
          const tripTransaction = db.transaction(['trips'], 'readwrite');
          const tripStore = tripTransaction.objectStore('trips');
          await new Promise((res, rej) => {
            const req = tripStore.delete(tripId);
            req.onsuccess = () => res();
            req.onerror = () => rej(req.error);
          });

          // é–¢é€£ã™ã‚‹ç´ æã‚’å‰Šé™¤
          const materials = await getMaterials(tripId);
          for (const material of materials) {
            await deleteMaterial(material.id);
          }

          // é–¢é€£ã™ã‚‹ãƒ–ãƒ­ã‚°ã‚’å‰Šé™¤
          const blogs = await getBlogs(tripId);
          for (const blog of blogs) {
            await deleteBlog(blog.id);
          }

          resolve();
        } catch (error) {
          reject(error);
        }
      });
    }

    // ç¢ºèªä»˜ãæ—…è¡Œå‰Šé™¤
    async function deleteTripWithConfirm() {
      const tripSelect = document.getElementById('tripSelect');
      const tripId = parseInt(tripSelect.value);
      
      if (!tripId) {
        showToast('å‰Šé™¤ã™ã‚‹æ—…ã‚’é¸æŠã—ã¦ã­ï¼', 'error');
        return;
      }

      const trips = await getTrips();
      const trip = trips.find(t => t.id === tripId);
      
      if (!trip) {
        showToast('æ—…ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆ', 'error');
        return;
      }

      if (confirm(`ã€Œ${trip.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ—…ã«é–¢é€£ã™ã‚‹å†™çœŸãƒ»ãƒ¡ãƒ¢ãƒ»ãƒ–ãƒ­ã‚°ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
        try {
          await deleteTrip(tripId);
          await loadTrips();
          await loadMaterialList();
          showToast('æ—…ã‚’å‰Šé™¤ã—ãŸã‚ˆ ğŸ—‘ï¸', 'success');
        } catch (error) {
          console.error('Delete trip error:', error);
          showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      }
    }

    // ç´ æã‚’å–å¾—
    async function getMaterials(tripId = null) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['materials'], 'readonly');
        const store = transaction.objectStore('materials');
        
        if (tripId) {
          const index = store.index('tripId');
          const request = index.getAll(tripId);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        } else {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        }
      });
    }

    // ç´ æã‚’è¿½åŠ 
    async function addMaterial(material) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['materials'], 'readwrite');
        const store = transaction.objectStore('materials');
        const request = store.add(material);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // ç´ æã‚’å‰Šé™¤
    async function deleteMaterial(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['materials'], 'readwrite');
        const store = transaction.objectStore('materials');
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ãƒ–ãƒ­ã‚°ã‚’ä¿å­˜
    async function saveBlog(blog) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['blogs'], 'readwrite');
        const store = transaction.objectStore('blogs');
        const request = store.add(blog);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // ãƒ–ãƒ­ã‚°ã‚’å–å¾—
    async function getBlogs(tripId = null) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['blogs'], 'readonly');
        const store = transaction.objectStore('blogs');
        
        if (tripId) {
          const index = store.index('tripId');
          const request = index.getAll(tripId);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        } else {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        }
      });
    }

    // ãƒ–ãƒ­ã‚°ã‚’å‰Šé™¤
    async function deleteBlog(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['blogs'], 'readwrite');
        const store = transaction.objectStore('blogs');
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        if (btn.dataset.tab === 'materials') {
          renderMaterials();
        } else if (btn.dataset.tab === 'generate') {
          updateTripStats();
        }
      });
    });

    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');

    dropzone.addEventListener('click', () => {
      const tripId = parseInt(document.getElementById('tripSelect').value);
      if (!tripId) {
        showToast('å…ˆã«æ—…è¡Œã‚’é¸æŠã—ã¦ã­ï¼ â†‘', 'error');
        document.getElementById('tripSelect').focus();
        return;
      }
      fileInput.click();
    });
    
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      await handleFiles(files);
    });

    fileInput.addEventListener('change', async (e) => {
      await handleFiles(e.target.files);
      fileInput.value = '';
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    async function handleFiles(files) {
      const tripId = parseInt(document.getElementById('tripSelect').value);
      if (!tripId) {
        showToast('å…ˆã«æ—…è¡Œã‚’é¸æŠã—ã¦ã­ï¼', 'error');
        return;
      }

      for (const file of files) {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            const material = {
              tripId: tripId,
              type: 'photo',
              content: e.target.result,
              fileName: file.name,
              createdAt: new Date().toISOString()
            };
            await addMaterial(material);
            showToast('å†™çœŸã‚’è¿½åŠ ã—ãŸã‚ˆï¼ ğŸ“¸', 'success');
          };
          reader.readAsDataURL(file);
        }
      }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
    async function addTextMaterial() {
      const tripId = parseInt(document.getElementById('tripSelect').value);
      const text = document.getElementById('textInput').value.trim();

      if (!tripId) {
        showToast('å…ˆã«æ—…è¡Œã‚’é¸æŠã—ã¦ã­ï¼', 'error');
        return;
      }

      if (!text) {
        showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ã­ï¼', 'error');
        return;
      }

      const material = {
        tripId: tripId,
        type: 'text',
        content: text,
        createdAt: new Date().toISOString()
      };

      await addMaterial(material);
      document.getElementById('textInput').value = '';
      showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ãŸã‚ˆï¼ ğŸ’¬', 'success');
    }

    // ç´ æä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    async function renderMaterials() {
      const filterTripId = document.getElementById('materialsFilterTrip').value;
      const materials = await getMaterials(filterTripId ? parseInt(filterTripId) : null);
      const trips = await getTrips();
      const tripMap = {};
      trips.forEach(t => tripMap[t.id] = t.name);

      const grid = document.getElementById('materialsGrid');
      const empty = document.getElementById('materialsEmpty');

      if (materials.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      grid.innerHTML = materials.map(m => {
        if (m.type === 'photo') {
          return `
            <div class="material-card">
              <img src="${m.content}" alt="æ—…ã®å†™çœŸ">
              <div class="card-footer">
                <span class="material-type type-photo">ğŸ“¸ å†™çœŸ</span>
                <button class="btn-delete" onclick="removeMaterial(${m.id})">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        } else {
          return `
            <div class="material-card">
              <div class="text-preview">${m.content.substring(0, 100)}${m.content.length > 100 ? '...' : ''}</div>
              <div class="card-footer">
                <span class="material-type type-text">ğŸ’¬ ãƒ†ã‚­ã‚¹ãƒˆ</span>
                <button class="btn-delete" onclick="removeMaterial(${m.id})">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }
      }).join('');
    }

    // ç´ æå‰Šé™¤
    async function removeMaterial(id) {
      if (confirm('ã“ã®ç´ æã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ')) {
        await deleteMaterial(id);
        await renderMaterials();
        showToast('å‰Šé™¤ã—ãŸã‚ˆï¼', 'success');
      }
    }

    // æ—…è¡Œçµ±è¨ˆã‚’æ›´æ–°
    async function updateTripStats() {
      const tripId = document.getElementById('generateTripSelect').value;
      if (!tripId) {
        document.getElementById('photoCount').textContent = '0';
        document.getElementById('textCount').textContent = '0';
        document.getElementById('totalCount').textContent = '0';
        return;
      }

      const materials = await getMaterials(parseInt(tripId));
      const photos = materials.filter(m => m.type === 'photo').length;
      const texts = materials.filter(m => m.type === 'text').length;

      document.getElementById('photoCount').textContent = photos;
      document.getElementById('textCount').textContent = texts;
      document.getElementById('totalCount').textContent = photos + texts;
    }

    document.getElementById('generateTripSelect').addEventListener('change', updateTripStats);

    // ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ
    document.querySelectorAll('.style-option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.style-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
    });

    // ãƒ–ãƒ­ã‚°ç”Ÿæˆ
    async function generateBlog() {
      const tripId = document.getElementById('generateTripSelect').value;
      if (!tripId) {
        showToast('æ—…è¡Œã‚’é¸æŠã—ã¦ã­ï¼', 'error');
        return;
      }

      const trips = await getTrips();
      const trip = trips.find(t => t.id === parseInt(tripId));
      const materials = await getMaterials(parseInt(tripId));

      if (materials.length === 0) {
        showToast('ç´ æãŒãªã„ã‚ˆï¼å…ˆã«è¿½åŠ ã—ã¦ã­', 'error');
        return;
      }

      const style = document.querySelector('.style-option.selected').dataset.style;
      const btn = document.getElementById('generateBtn');
      const btnText = btn.querySelector('.btn-text');
      const loading = btn.querySelector('.loading');

      btn.disabled = true;
      btnText.style.display = 'none';
      loading.classList.add('active');

      try {
        // Claude APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ–ãƒ­ã‚°ç”Ÿæˆ
        const blogContent = await callClaudeAPI(trip, materials, style);
        
        // ä¿å­˜ç”¨ã«ç¾åœ¨ã®æ—…è¡ŒIDã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨˜éŒ²
        currentBlogTripId = trip.id;
        currentBlogStyle = style;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤º
        document.getElementById('previewFrame').innerHTML = blogContent;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('[data-tab="preview"]').classList.add('active');
        document.getElementById('tab-preview').classList.add('active');

        showToast('ãƒ–ãƒ­ã‚°ã‚’ç”Ÿæˆã—ãŸã‚ˆï¼ ğŸ‰', 'success');
      } catch (error) {
        console.error('Error generating blog:', error);
        // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç”»é¢ã«è¡¨ç¤º
        document.getElementById('previewFrame').innerHTML = `
          <div style="padding: 1.5rem; background: #FFE0E0; border-radius: 12px;">
            <h3 style="color: #FF6B6B; margin-bottom: 1rem;">ğŸ˜¢ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚ˆ</h3>
            <p style="word-break: break-all;">${error.message}</p>
            <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
              â€» APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­
            </p>
          </div>
        `;
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('[data-tab="preview"]').classList.add('active');
        document.getElementById('tab-preview').classList.add('active');
        showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸ...', 'error');
      } finally {
        btn.disabled = false;
        btnText.style.display = 'inline';
        loading.classList.remove('active');
      }
    }

    // Claude APIå‘¼ã³å‡ºã—
    async function callClaudeAPI(trip, materials, style) {
      const stylePrompts = {
        casual: 'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªå£èª¿ã§ã€å‹é”ã«è©±ã™ã‚ˆã†ã«',
        diary: 'æ—¥è¨˜ã®ã‚ˆã†ãªè¦ªã—ã¿ã‚„ã™ã„ä¸€äººç§°ã§ã€ãã®æ—¥ã®æ„Ÿæƒ³ã‚’äº¤ãˆã¦',
        magazine: 'æ—…è¡Œé›‘èªŒã®è¨˜äº‹ã®ã‚ˆã†ã«ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§é­…åŠ›çš„ã«',
        poetic: 'ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ã§è©©çš„ãªè¡¨ç¾ã‚’ä½¿ã£ã¦ã€æ„Ÿå‹•ã‚’ä¼ãˆã‚‹ã‚ˆã†ã«'
      };

      const texts = materials.filter(m => m.type === 'text').map(m => m.content).join('\n\n');
      const photos = materials.filter(m => m.type === 'photo');
      const photoCount = photos.length;

      // APIã‚­ãƒ¼ã¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
      const apiKey = getApiKey();
      const provider = getProvider();
      
      if (!apiKey) {
        throw new Error('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã­ï¼ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã®å…¥åŠ›æ¬„ã«APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      // å†™çœŸã®èª¬æ˜ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆVision APIã‚’ä½¿ã†å ´åˆã«å‚ç…§ç”¨ï¼‰
      const photoDescriptions = photos.map((_, i) => `[PHOTO_${i + 1}]`).join(', ');

      const prompt = `
ã‚ãªãŸã¯æ—…è¡Œãƒ–ãƒ­ã‚°ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€é­…åŠ›çš„ãªæ—…è¡Œãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’HTMLã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ—…è¡Œåã€‘${trip.name}
ã€æ—¥ä»˜ã€‘${trip.date}
ã€å†™çœŸã®æ•°ã€‘${photoCount}æšï¼ˆ${photoDescriptions}ï¼‰
ã€æ—…è¡Œãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³ã€‘
${texts || '(ãƒ¡ãƒ¢ãªã—)'}

ã€æ–‡ç« ã‚¹ã‚¿ã‚¤ãƒ«ã€‘${stylePrompts[style]}

ã€é‡è¦ï¼šå†™çœŸã®é…ç½®ã«ã¤ã„ã¦ã€‘
æ·»ä»˜ã•ã‚ŒãŸå†™çœŸã®å†…å®¹ã‚’ç¢ºèªã—ã€ãƒ–ãƒ­ã‚°ã®æ–‡ç« å†…å®¹ã«åˆã£ãŸå ´æ‰€ã«å„å†™çœŸã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚
- é£Ÿã¹ç‰©ã®å†™çœŸ â†’ é£Ÿäº‹ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã‚‹æ®µè½ã®è¿‘ãã«
- æ™¯è‰²ã®å†™çœŸ â†’ ãã®å ´æ‰€ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã‚‹æ®µè½ã®è¿‘ãã«
- å»ºç‰©ãƒ»æ–½è¨­ã®å†™çœŸ â†’ ãã®æ–½è¨­ã«ã¤ã„ã¦è§¦ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã«
- äººç‰©ã®å†™çœŸ â†’ ä½“é¨“è«‡ã‚„æ€ã„å‡ºã‚’èªã£ã¦ã„ã‚‹éƒ¨åˆ†ã«

ã€å‡ºåŠ›å½¢å¼ã€‘
- å®Œå…¨ãªHTMLã¯ä¸è¦ã€‚è¨˜äº‹æœ¬æ–‡ã®HTMLã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- è¦‹å‡ºã—ï¼ˆh2, h3ï¼‰ã€æ®µè½ï¼ˆpï¼‰ã€ãƒªã‚¹ãƒˆï¼ˆul, liï¼‰ã‚’é©åˆ‡ã«ä½¿ç”¨
- å†™çœŸã®é…ç½®å ´æ‰€ã¯ [PHOTO_1], [PHOTO_2] ã®ã‚ˆã†ã«è¨˜è¼‰ï¼ˆå†™çœŸã®å†…å®¹ã«åˆã£ãŸå ´æ‰€ã«ï¼ï¼‰
- èª­ã¿ã‚„ã™ãã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æ¥½ã—ã‚ã‚‹æ§‹æˆã«
- çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ—ã«
- æœ€å¾Œã«ã¾ã¨ã‚ã‚„æ¬¡å›ã¸ã®æœŸå¾…ã‚’å…¥ã‚Œã‚‹
`;

      let response;
      let blogHtml;

      try {
        if (provider === 'google') {
          // Google Gemini API with Vision
          const parts = [
            { text: prompt }
          ];

          // å†™çœŸã‚’Vision APIã«é€ä¿¡
          photos.forEach((photo, index) => {
            const matches = photo.content.match(/^data:(.+);base64,(.+)$/);
            if (matches) {
              parts.push({
                inline_data: {
                  mime_type: matches[1],
                  data: matches[2]
                }
              });
              parts.push({
                text: `â†‘ ã“ã‚ŒãŒ [PHOTO_${index + 1}] ã§ã™`
              });
            }
          });

          response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                parts: parts
              }],
              generationConfig: {
                maxOutputTokens: 4000
              }
            })
          });

          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Google response parse error:', responseText);
            throw new Error(`Google APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${responseText.substring(0, 100)}`);
          }

          if (!response.ok) {
            throw new Error(data.error?.message || `Google APIã‚¨ãƒ©ãƒ¼ (${response.status})`);
          }

          if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            throw new Error('Google APIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
          }

          blogHtml = data.candidates[0].content.parts[0].text;
          // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜æ³•ã‚’é™¤å»
          blogHtml = blogHtml.replace(/^```html\n?/i, '').replace(/^```\n?/i, '').replace(/\n?```$/g, '');

        } else if (provider === 'openai') {
          // OpenAI API with Visionï¼ˆå†™çœŸã®å†…å®¹ã‚’èªè­˜ï¼‰
          const messageContent = [
            { type: 'text', text: prompt }
          ];

          // å†™çœŸã‚’Vision APIã«é€ä¿¡ï¼ˆå†…å®¹ã‚’èªè­˜ã•ã›ã‚‹ï¼‰
          photos.forEach((photo, index) => {
            messageContent.push({
              type: 'image_url',
              image_url: {
                url: photo.content,
                detail: 'low' // ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ä½è§£åƒåº¦ã§èªè­˜
              }
            });
            messageContent.push({
              type: 'text',
              text: `â†‘ ã“ã‚ŒãŒ [PHOTO_${index + 1}] ã§ã™`
            });
          });

          response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o',
              max_tokens: 4000,
              messages: [
                { role: 'user', content: messageContent }
              ]
            })
          });

          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('OpenAI response parse error:', responseText);
            throw new Error(`OpenAI APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${responseText.substring(0, 100)}`);
          }

          if (!response.ok) {
            throw new Error(data.error?.message || `OpenAI APIã‚¨ãƒ©ãƒ¼ (${response.status})`);
          }

          if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('OpenAI APIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
          }

          blogHtml = data.choices[0].message.content;
          // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜æ³•ã‚’é™¤å»
          blogHtml = blogHtml.replace(/^```html\n?/i, '').replace(/^```\n?/i, '').replace(/\n?```$/g, '');

        } else {
          // Anthropic API with Visionï¼ˆå†™çœŸã®å†…å®¹ã‚’èªè­˜ï¼‰
          const messageContent = [];

          // å†™çœŸã‚’Vision APIã«é€ä¿¡
          photos.forEach((photo, index) => {
            // base64ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰media_typeã¨dataã‚’æŠ½å‡º
            const matches = photo.content.match(/^data:(.+);base64,(.+)$/);
            if (matches) {
              messageContent.push({
                type: 'image',
                source: {
                  type: 'base64',
                  media_type: matches[1],
                  data: matches[2]
                }
              });
              messageContent.push({
                type: 'text',
                text: `â†‘ ã“ã‚ŒãŒ [PHOTO_${index + 1}] ã§ã™`
              });
            }
          });

          // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
          messageContent.push({ type: 'text', text: prompt });

          response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4000,
              messages: [
                { role: 'user', content: messageContent }
              ]
            })
          });

          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Anthropic response parse error:', responseText);
            throw new Error(`Anthropic APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${responseText.substring(0, 100)}`);
          }

          if (!response.ok) {
            throw new Error(data.error?.message || `Anthropic APIã‚¨ãƒ©ãƒ¼ (${response.status})`);
          }

          if (!data.content || !data.content[0] || !data.content[0].text) {
            throw new Error('Anthropic APIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
          }

          blogHtml = data.content[0].text;
          // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜æ³•ã‚’é™¤å»
          blogHtml = blogHtml.replace(/^```html\n?/i, '').replace(/^```\n?/i, '').replace(/\n?```$/g, '');
        }
      } catch (fetchError) {
        if (fetchError.message.includes('API')) {
          throw fetchError;
        }
        throw new Error(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${fetchError.message}`);
      }

      // å†™çœŸã‚’æŒ¿å…¥ï¼ˆã‚µãƒ ãƒã‚¤ãƒ« + ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ï¼‰
      photos.forEach((photo, index) => {
        const placeholder = `[PHOTO_${index + 1}]`;
        const imgTag = `
          <div class="photo-thumbnail" onclick="openLightbox('${photo.content.replace(/'/g, "\\'")}')">
            <img src="${photo.content}" alt="æ—…ã®å†™çœŸ${index + 1}">
            <div class="photo-zoom-hint">ğŸ” ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§</div>
          </div>
        `;
        blogHtml = blogHtml.replace(placeholder, imgTag);
      });

      // ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
      return `
        <style>
          .blog-content { font-family: 'Zen Maru Gothic', sans-serif; line-height: 1.8; color: #2D3436; }
          .blog-content h2 { color: #FF6B6B; margin-top: 2rem; margin-bottom: 1rem; }
          .blog-content h3 { color: #4ECDC4; margin-top: 1.5rem; margin-bottom: 0.75rem; }
          .blog-content p { margin-bottom: 1rem; }
          .blog-content ul { padding-left: 1.5rem; margin-bottom: 1rem; }
          .blog-content li { margin-bottom: 0.5rem; }
          .photo-thumbnail {
            position: relative;
            cursor: pointer;
            margin: 1rem auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            width: fit-content;
            max-width: 100%;
          }
          .photo-thumbnail:hover, .photo-thumbnail:active {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
          }
          .photo-thumbnail img {
            width: auto;
            height: 120px;
            max-width: 100%;
            object-fit: cover;
            display: block;
            background: #f5f5f5;
          }
          @media (min-width: 769px) {
            .photo-thumbnail img {
              height: 180px;
            }
          }
          .photo-zoom-hint {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            opacity: 0.8;
          }
        </style>
        <div class="blog-content">
          <h1 style="color: #A66CFF; margin-bottom: 0.5rem;">${trip.name}</h1>
          <p style="color: #888; margin-bottom: 2rem;">ğŸ“… ${trip.date}</p>
          ${blogHtml}
        </div>
      `;
    }

    // ãƒ–ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼
    function copyBlog() {
      const content = document.getElementById('previewFrame').innerText;
      navigator.clipboard.writeText(content).then(() => {
        showToast('ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼ ğŸ“‹', 'success');
      });
    }

    // ç¾åœ¨ã®ãƒ–ãƒ­ã‚°ã‚’ä¿å­˜
    let currentBlogTripId = null;
    let currentBlogStyle = null;

    async function saveCurrentBlog() {
      const content = document.getElementById('previewFrame').innerHTML;
      
      if (!content || content.includes('preview-placeholder')) {
        showToast('ä¿å­˜ã™ã‚‹ãƒ–ãƒ­ã‚°ãŒãªã„ã‚ˆï¼', 'error');
        return;
      }

      if (!currentBlogTripId) {
        showToast('æ—…è¡Œæƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„...', 'error');
        return;
      }

      const trips = await getTrips();
      const trip = trips.find(t => t.id === currentBlogTripId);
      
      const blog = {
        tripId: currentBlogTripId,
        tripName: trip ? trip.name : 'ä¸æ˜ãªæ—…è¡Œ',
        style: currentBlogStyle || 'casual',
        content: content,
        createdAt: new Date().toISOString()
      };

      await saveBlog(blog);
      showToast('ãƒ–ãƒ­ã‚°ã‚’ä¿å­˜ã—ãŸã‚ˆï¼ ğŸ’–', 'success');
      loadSavedBlogs();
    }

    // ä¿å­˜æ¸ˆã¿ãƒ–ãƒ­ã‚°ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadSavedBlogs() {
      const blogs = await getBlogs();
      const container = document.getElementById('savedBlogsList');
      
      if (blogs.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center; padding: 1rem;">ã¾ã ä¿å­˜ã—ãŸãƒ–ãƒ­ã‚°ãŒãªã„ã‚ˆ</p>';
        return;
      }

      // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
      blogs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      container.innerHTML = blogs.map(blog => `
        <div class="saved-blog-item" style="background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #2D3436;">${blog.tripName}</div>
            <div style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
              ${new Date(blog.createdAt).toLocaleDateString('ja-JP')} ä¿å­˜
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="viewSavedBlog(${blog.id})" style="background: #4ECDC4; color: white; border: none; border-radius: 8px; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.85rem;">ğŸ‘€ è¦‹ã‚‹</button>
            <button onclick="deleteSavedBlog(${blog.id})" style="background: #FF6B6B; color: white; border: none; border-radius: 8px; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.85rem;">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }

    // ä¿å­˜æ¸ˆã¿ãƒ–ãƒ­ã‚°ã‚’è¡¨ç¤º
    async function viewSavedBlog(blogId) {
      const blogs = await getBlogs();
      const blog = blogs.find(b => b.id === blogId);
      
      if (blog) {
        document.getElementById('previewFrame').innerHTML = blog.content;
        showToast('ä¿å­˜ã—ãŸãƒ–ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ãŸã‚ˆï¼', 'success');
      }
    }

    // ä¿å­˜æ¸ˆã¿ãƒ–ãƒ­ã‚°ã‚’å‰Šé™¤
    async function deleteSavedBlog(blogId) {
      if (confirm('ã“ã®ãƒ–ãƒ­ã‚°ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ')) {
        await deleteBlog(blogId);
        showToast('ãƒ–ãƒ­ã‚°ã‚’å‰Šé™¤ã—ãŸã‚ˆ', 'success');
        loadSavedBlogs();
      }
    }

    // ãƒ–ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadBlog() {
      const content = document.getElementById('previewFrame').innerHTML;
      const fullHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—…ãƒ–ãƒ­ã‚° - TaviLog</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { max-width: 800px; margin: 0 auto; padding: 2rem; background: #FFF9F0; }
  </style>
</head>
<body>
  ${content}
</body>
</html>`;

      const blob = new Blob([fullHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'travel-blog.html';
      a.click();
      URL.revokeObjectURL(url);
      showToast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚ˆï¼ ğŸ’¾', 'success');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openNewTripModal() {
      document.getElementById('newTripModal').classList.add('active');
      document.getElementById('tripDateInput').valueAsDate = new Date();
    }

    function closeNewTripModal() {
      document.getElementById('newTripModal').classList.remove('active');
      document.getElementById('tripNameInput').value = '';
    }

    // APIãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openApiHelpModal() {
      document.getElementById('apiHelpModal').classList.add('active');
    }

    function closeApiHelpModal() {
      document.getElementById('apiHelpModal').classList.remove('active');
    }

    async function createNewTrip() {
      const name = document.getElementById('tripNameInput').value.trim();
      const date = document.getElementById('tripDateInput').value;

      if (!name) {
        showToast('æ—…è¡Œã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼', 'error');
        return;
      }

      const trip = { name, date, createdAt: new Date().toISOString() };
      await addTrip(trip);
      closeNewTripModal();
      await loadTrips();
      showToast('æ–°ã—ã„æ—…ã‚’ä½œæˆã—ãŸã‚ˆï¼ ğŸ§³', 'success');
    }

    // æ—…è¡Œä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTrips() {
      const trips = await getTrips();
      const options = trips.map(t => `<option value="${t.id}">${t.name} (${t.date})</option>`).join('');
      
      document.getElementById('tripSelect').innerHTML = '<option value="">æ—…è¡Œã‚’é¸æŠ...</option>' + options;
      document.getElementById('materialsFilterTrip').innerHTML = '<option value="">ã™ã¹ã¦ã®æ—…è¡Œ</option>' + options;
      document.getElementById('generateTripSelect').innerHTML = '<option value="">ç”Ÿæˆã™ã‚‹æ—…è¡Œã‚’é¸æŠ...</option>' + options;
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // APIã‚­ãƒ¼ãƒ»ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ç®¡ç†
    function getProvider() {
      return localStorage.getItem('tavilog_provider') || 'google';
    }

    function saveProvider(provider) {
      localStorage.setItem('tavilog_provider', provider);
    }

    function getApiKey() {
      const provider = getProvider();
      return localStorage.getItem(`tavilog_api_key_${provider}`) || '';
    }

    function saveApiKey(key) {
      const provider = getProvider();
      localStorage.setItem(`tavilog_api_key_${provider}`, key);
      updateApiKeyStatus();
    }

    function updateApiKeyStatus() {
      const key = getApiKey();
      const provider = getProvider();
      const status = document.getElementById('apiKeyStatus');
      
      let isValid = false;
      if (provider === 'openai' && key && key.startsWith('sk-')) {
        isValid = true;
      } else if (provider === 'anthropic' && key && key.startsWith('sk-ant-')) {
        isValid = true;
      }
      
      if (isValid) {
        status.textContent = 'âœ“ è¨­å®šæ¸ˆã¿';
        status.className = 'api-key-status valid';
      } else if (key) {
        status.textContent = 'å½¢å¼ç¢ºèª';
        status.className = 'api-key-status invalid';
      } else {
        status.textContent = 'æœªè¨­å®š';
        status.className = 'api-key-status invalid';
      }
    }

    // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('aiProvider').addEventListener('change', (e) => {
      saveProvider(e.target.value);
      // ä¿å­˜æ¸ˆã¿ã®APIã‚­ãƒ¼ã‚’å¾©å…ƒ
      const savedKey = getApiKey();
      document.getElementById('apiKeyInput').value = savedKey;
      updateApiKeyStatus();
      const providerName = e.target.value === 'openai' ? 'ChatGPT' : 'Claude';
      showToast(`${providerName}ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚ˆï¼`, 'success');
    });

    // APIã‚­ãƒ¼å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('apiKeyInput').addEventListener('change', (e) => {
      saveApiKey(e.target.value);
      showToast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ãŸã‚ˆï¼ ğŸ”‘', 'success');
    });

    document.getElementById('apiKeyInput').addEventListener('input', (e) => {
      const key = e.target.value;
      const provider = getProvider();
      const status = document.getElementById('apiKeyStatus');
      
      let isValid = false;
      if (provider === 'openai' && key && key.startsWith('sk-')) {
        isValid = true;
      } else if (provider === 'anthropic' && key && key.startsWith('sk-ant-')) {
        isValid = true;
      }
      
      if (isValid) {
        status.textContent = 'âœ“ æœ‰åŠ¹';
        status.className = 'api-key-status valid';
      } else if (key) {
        status.textContent = 'å½¢å¼ç¢ºèª';
        status.className = 'api-key-status invalid';
      } else {
        status.textContent = 'æœªè¨­å®š';
        status.className = 'api-key-status invalid';
      }
    });

    // ========== ãƒ‡ãƒ¼ã‚¿ç®¡ç† ==========
    
    // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    async function clearAllData() {
      if (!confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ãªã„ã‚ˆï¼')) {
        return;
      }
      
      const transaction = db.transaction(['trips', 'materials', 'blogs'], 'readwrite');
      await Promise.all([
        new Promise(r => { transaction.objectStore('trips').clear().onsuccess = r; }),
        new Promise(r => { transaction.objectStore('materials').clear().onsuccess = r; }),
        new Promise(r => { transaction.objectStore('blogs').clear().onsuccess = r; })
      ]);
      
      await loadTrips();
      await loadSavedBlogs();
      showToast('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ãŸã‚ˆ', 'success');
    }

    // ========== ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ==========

    async function exportData() {
      try {
        const trips = await getTrips();
        const materials = await getMaterials();
        const data = {
          trips,
          materials,
          exportedAt: new Date().toISOString(),
          version: '1.0'
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tavilog-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã‚ˆï¼ ğŸ“¤', 'success');
      } catch (error) {
        showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—...', 'error');
      }
    }

    async function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data.trips || !data.materials) {
          throw new Error('Invalid format');
        }

        if (!confirm(`${data.trips.length}ä»¶ã®æ—…è¡Œã¨${data.materials.length}ä»¶ã®ç´ æã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã‚‹ã‚ˆã€‚`)) {
          return;
        }

        for (const trip of data.trips) {
          const { id, ...tripData } = trip; // idã‚’é™¤å¤–
          await addTrip(tripData);
        }

        for (const material of data.materials) {
          const { id, ...materialData } = material;
          await addMaterial(materialData);
        }

        await loadTrips();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã‚ˆï¼ ğŸ“¥', 'success');
      } catch (error) {
        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—...ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ã­', 'error');
      }

      event.target.value = '';
    }

    // clearAllData ã¯ä¸Šéƒ¨ã§å®šç¾©æ¸ˆã¿ï¼ˆå¼•æ•°showConfirmå¯¾å¿œç‰ˆï¼‰

    // ========== åˆæœŸåŒ– ==========

    // ========== åˆæœŸåŒ– ==========
    
    initDB().then(() => {
      loadTrips();
      loadSavedBlogs();
      
      // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨APIã‚­ãƒ¼ã‚’å¾©å…ƒ
      const savedProvider = getProvider();
      document.getElementById('aiProvider').value = savedProvider;
      const savedKey = getApiKey();
      if (savedKey) {
        document.getElementById('apiKeyInput').value = savedKey;
      }
      updateApiKeyStatus();

      console.log('TaviLog initialized! ğŸš€');
    });

    // ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆå†™çœŸæ‹¡å¤§è¡¨ç¤ºï¼‰
    function openLightbox(imageSrc) {
      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightbox-img');
      lightboxImg.src = imageSrc;
      lightbox.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      lightbox.style.display = 'none';
      document.body.style.overflow = '';
    }

    // ========== ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ ==========

    let isEditMode = false;

    function toggleEditMode() {
      isEditMode = !isEditMode;
      const previewFrame = document.getElementById('previewFrame');
      const editBtn = document.getElementById('editModeBtn');

      if (isEditMode) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON
        previewFrame.classList.add('edit-mode');
        editBtn.textContent = 'ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
        editBtn.style.background = 'linear-gradient(135deg, #4ECDC4, #44A08D)';
        editBtn.style.color = 'white';

        // å†™çœŸãƒ–ãƒ­ãƒƒã‚¯ã«ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        addPhotoEditControls();

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†å¯èƒ½ã«
        enableTextEditing();

        showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON âœï¸', 'success');
      } else {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFF
        previewFrame.classList.remove('edit-mode');
        editBtn.textContent = 'âœï¸ ç·¨é›†';
        editBtn.style.background = 'linear-gradient(135deg, #FFE66D, #FFA500)';
        editBtn.style.color = '#2D3436';

        // ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ã‚’ç„¡åŠ¹åŒ–
        disableTextEditing();

        showToast('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã£ãŸã‚ˆ ğŸ‘ï¸', 'success');
      }
    }

    function addPhotoEditControls() {
      const previewFrame = document.getElementById('previewFrame');
      const photoThumbnails = previewFrame.querySelectorAll('.photo-thumbnail');

      photoThumbnails.forEach((thumbnail, index) => {
        // æ—¢ã«wrapperã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (thumbnail.parentElement.classList.contains('photo-block-wrapper')) {
          return;
        }

        // å†™çœŸãƒ–ãƒ­ãƒƒã‚¯ã‚’wrapperã§å›²ã‚€
        const wrapper = document.createElement('div');
        wrapper.className = 'photo-block-wrapper';
        thumbnail.parentNode.insertBefore(wrapper, thumbnail);
        wrapper.appendChild(thumbnail);

        // ç·¨é›†ç”¨ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const controls = document.createElement('div');
        controls.className = 'photo-edit-controls';
        controls.innerHTML = `
          <button class="photo-edit-btn btn-up" onclick="movePhotoUp(this)" title="ä¸Šã«ç§»å‹•">â†‘</button>
          <button class="photo-edit-btn btn-down" onclick="movePhotoDown(this)" title="ä¸‹ã«ç§»å‹•">â†“</button>
          <button class="photo-edit-btn btn-delete" onclick="deletePhoto(this)" title="å‰Šé™¤">Ã—</button>
        `;
        wrapper.appendChild(controls);
      });
    }

    function enableTextEditing() {
      const previewFrame = document.getElementById('previewFrame');
      const editableElements = previewFrame.querySelectorAll('.blog-content h1, .blog-content h2, .blog-content h3, .blog-content p, .blog-content li');

      editableElements.forEach(el => {
        el.setAttribute('contenteditable', 'true');
      });
    }

    function disableTextEditing() {
      const previewFrame = document.getElementById('previewFrame');
      const editableElements = previewFrame.querySelectorAll('[contenteditable="true"]');

      editableElements.forEach(el => {
        el.removeAttribute('contenteditable');
      });
    }

    function movePhotoUp(btn) {
      const wrapper = btn.closest('.photo-block-wrapper');
      const prevWrapper = wrapper.previousElementSibling;

      // å‰ã®è¦ç´ ãŒå†™çœŸãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆã®ã¿ç§»å‹•
      if (prevWrapper && prevWrapper.classList.contains('photo-block-wrapper')) {
        wrapper.parentNode.insertBefore(wrapper, prevWrapper);
        showToast('å†™çœŸã‚’ä¸Šã«ç§»å‹•ã—ãŸã‚ˆ â†‘', 'success');
      } else {
        // å‰ã®è¦ç´ ãŒãƒ–ãƒ­ã‚°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä»–ã®è¦ç´ ã®å ´åˆã‚‚ç§»å‹•ã‚’è¨±å¯
        const blogContent = wrapper.closest('.blog-content');
        const allChildren = Array.from(blogContent.children);
        const currentIndex = allChildren.indexOf(wrapper);

        if (currentIndex > 0) {
          const targetElement = allChildren[currentIndex - 1];
          wrapper.parentNode.insertBefore(wrapper, targetElement);
          showToast('å†™çœŸã‚’ä¸Šã«ç§»å‹•ã—ãŸã‚ˆ â†‘', 'success');
        } else {
          showToast('ã“ã‚Œä»¥ä¸Šä¸Šã«ã¯ç§»å‹•ã§ããªã„ã‚ˆ', 'error');
        }
      }
    }

    function movePhotoDown(btn) {
      const wrapper = btn.closest('.photo-block-wrapper');
      const nextWrapper = wrapper.nextElementSibling;

      // æ¬¡ã®è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç§»å‹•
      if (nextWrapper) {
        wrapper.parentNode.insertBefore(nextWrapper, wrapper);
        showToast('å†™çœŸã‚’ä¸‹ã«ç§»å‹•ã—ãŸã‚ˆ â†“', 'success');
      } else {
        showToast('ã“ã‚Œä»¥ä¸Šä¸‹ã«ã¯ç§»å‹•ã§ããªã„ã‚ˆ', 'error');
      }
    }

    function deletePhoto(btn) {
      if (confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ')) {
        const wrapper = btn.closest('.photo-block-wrapper');
        wrapper.remove();
        showToast('å†™çœŸã‚’å‰Šé™¤ã—ãŸã‚ˆ ğŸ—‘ï¸', 'success');
      }
    }
  </script>

  <!-- ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆå†™çœŸæ‹¡å¤§è¡¨ç¤ºç”¨ï¼‰ -->
  <div id="lightbox" onclick="closeLightbox()" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
  ">
    <img id="lightbox-img" style="
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    " onclick="event.stopPropagation()">
    <div style="
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      background: rgba(0,0,0,0.5);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    " onclick="closeLightbox()">âœ•</div>
    <div style="
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
    ">ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹</div>
  </div>
</body>
</html>
